<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>李轲的个人小站</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="转移一些有道云的内核学习和项目驱动调试笔记">
<meta property="og:type" content="website">
<meta property="og:title" content="李轲的个人小站">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="李轲的个人小站">
<meta property="og:description" content="转移一些有道云的内核学习和项目驱动调试笔记">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="leon">
<meta property="article:tag" content="linux驱动">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="李轲的个人小站" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">李轲的个人小站</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">三年工作经验linux驱动工程师一枚</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-uboot" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/04/27/uboot/" class="article-date">
  <time class="dt-published" datetime="2025-04-27T11:30:17.000Z" itemprop="datePublished">2025-04-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/04/27/uboot/">uboot详解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在rk平台上 uboot的适配已经非常完善，基本不需要开发人员进行二次开发</p>
<p>但是如海思，fulhan此类，需要用到tftp烧录和flash的平台，需要在uboot里面修改bootarg</p>
<p>bootcmd,还需要移植phy的驱动等，如果只有一个mac对接的swith，甚至需要移植交换机的驱动</p>
<p>深入学习uboot还是很有必要的，以下为我个人对uboot 的学习笔记，主要参考各路大神，</p>
<p>让自己对uboot不只是停留在表面，而是结合arm架构对uboot有一个更深刻的认识</p>
<p>本文参考csdn 对海思3521a对uboot 2010.06的分析</p>
<p><a target="_blank" rel="noopener" href="https://caibiao-lee.blog.csdn.net/article/details/103239130">https://caibiao-lee.blog.csdn.net/article/details/103239130</a></p>
<p>以及以及知乎博主等等</p>
<p>对fulhan为平台使用的 2017.09 uboot进行分析，以便于更深刻的理解uboot的启动流程和dm驱动框架</p>
<p>个人学习笔记。</p>
<h1 id="1-顶层makefile"><a href="#1-顶层makefile" class="headerlink" title="1.顶层makefile"></a>1.顶层makefile</h1><p>主要功能：</p>
<ol>
<li><strong>确定版本号及主机信息</strong></li>
</ol>
<p>确认版本号</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173648508.png" alt="image-20250428173648508"></p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172401481.png" alt="image-20250428172401481"></p>
<p>获取cpu架构 和 os</p>
<p>makefile的函数调用与变量调用很类似，格式是$( function arguments)，其实上面一大段的意思是变量HOSTARCH的值是一个函数的返回值shell是makefile中的一个函数，$(shell XXX)会被解析成执行shell命令XXX；此处是执行了一条 uname -m |sed -e ……，符号 \是makefile的换行符其中，|是shell语法中的管道结构，例如：XXX | YYY ，表达式XXX 的输出将作为表达式YYY的输入，YYY的输出才是整句表达式的输出uname -m 指令将输出负责编译的主机cpu架构，比如ixx86；sed -e是替换命令，比如把ixx86替换为i386,由此可见这个HOSTARCH变量的值将得到负责编译的主机cpu架构。大部分情况下我们得到的都是i386</p>
<p>这个HOSTOS变量和上一句HOSTARCH变量的原理类似，管道第一部分uname -s会得到负责编译的主机的OS，比如Linux</p>
<p>管道第二部分是将大写转换成小写</p>
<p>管道第三部分的意思是如果前面一个部分得到了cygwin系统，则格式要转换一下。不必深究，因为cygwin基本没人用……</p>
<p>由此可见这个HOSTOS变量的值将得到负责编译的主机操作系统，大部分情况下我们得到的都是linux</p>
<ol>
<li><strong>设置各种路径</strong></li>
</ol>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172418676.png" alt="image-20250428172418676"></p>
<p>这里开始阐述了makefile所支持的“单独外部路径编译”，</p>
<p>它的原理和keil把.o、.l、.bin、.a等中间文件放在单独的文件夹内的原理相同，都是为了使源码更简洁明了，</p>
<p>防止被中间文件污染；以及为了同时维护多个配置编译方式</p>
<p>若要使用单独外部路径编译，有两种方法，</p>
<p>方法一：例如在控制台中输入 make O&#x3D;&#x2F;tmp&#x2F;build ，将输出文件夹路径作为参数</p>
<p>方法二：导出环境变量，即export BUILD_DIR&#x3D;&#x2F;tmp&#x2F;build</p>
<p>注：方法一的优先级高，会覆盖方法二。</p>
<p>而且方法一必须每次输入make时都要输入参数（不论是make clean还是make config 的时候），</p>
<p>格式如make O&#x3D;&#x2F;tmp&#x2F;build disclean</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172434935.png" alt="image-20250428172434935"></p>
<p>设置obj的存放位置</p>
<ol>
<li><strong>设置编译工具链</strong></li>
</ol>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172450186.png" alt="image-20250428172450186"></p>
<ol>
<li><strong>设置规则</strong></li>
</ol>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172606243.png"></p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172628309.png" alt="image-20250428172628309"></p>
<p>本段出现了顶层makefile的第一条规则（即目标-依赖-操作），</p>
<p>故默认情况下将以all这个变量作为最终目标。但是由于本条规则没有任何操作，</p>
<p>所以一旦把依赖（也就是$(ALL)）实现了，整个makefile文件的最终目标就达成了</p>
<p>可以认为，本makefile的终极目标其实是$(ALL)所代表的那些文件</p>
<p>下面的这些都是为了产生最终文件的规则</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172651001.png" alt="image-20250428172651001"></p>
<h1 id="2-u-boot-lds"><a href="#2-u-boot-lds" class="headerlink" title="2.u-boot.lds"></a>2.u-boot.lds</h1><p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173754223.png" alt="image-20250428173754223"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line">/* SPDX-License-Identifier: GPL-2.0+ */</span><br><span class="line">/*</span><br><span class="line"> * (C) Copyright 2013</span><br><span class="line"> * David Feng &lt;fenghua@phytium.com.cn&gt;</span><br><span class="line"> *</span><br><span class="line"> * (C) Copyright 2002</span><br><span class="line"> * Gary Jennejohn, DENX Software Engineering, &lt;garyj@denx.de&gt;</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">#include &lt;config.h&gt;</span><br><span class="line">#include &lt;asm/psci.h&gt;</span><br><span class="line"></span><br><span class="line">OUTPUT_FORMAT(&quot;elf64-littleaarch64&quot;, &quot;elf64-littleaarch64&quot;, &quot;elf64-littleaarch64&quot;)</span><br><span class="line">OUTPUT_ARCH(aarch64)</span><br><span class="line">ENTRY(_start) -------------------------------------------------------------------- (1)</span><br><span class="line">/*</span><br><span class="line"> *（1）首先定义了二进制程序的输出格式为&quot;elf64-littleaarch64&quot;，</span><br><span class="line"> *    架构是&quot;aarch64&quot;，程序入口为&quot;_start&quot;符号；</span><br><span class="line"> */</span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">#ifdef CONFIG_ARMV8_SECURE_BASE -------------------------------------------------- (2)</span><br><span class="line">/*</span><br><span class="line"> *（2）ARMV8_SECURE_BASE是u-boot对PSCI的支持，在定义时可以将PSCI的文本段，</span><br><span class="line"> *    数据段，堆栈段重定向到指定的内存，而不是内嵌到u-boot中。</span><br><span class="line"> *    不过一般厂商实现会使用atf方式使其与bootloader分离，这个功能不常用；</span><br><span class="line"> */</span><br><span class="line"> /DISCARD/ : &#123; *(.rela._secure*) &#125;</span><br><span class="line">#endif</span><br><span class="line"> . = 0x00000000; -------------------------------------------------------------- (3)</span><br><span class="line">/*</span><br><span class="line"> *（3）定义了程序链接的基地址，默认是0，通过配置CONFIG_SYS_TEXT_BASE可修改</span><br><span class="line"> *    这个默认值。</span><br><span class="line"> */</span><br><span class="line"> . = ALIGN(8);</span><br><span class="line"> .text :</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__image_copy_start) --------------------------------------------------- (4)</span><br><span class="line">/*</span><br><span class="line"> *（4）__image_copy_start和__image_copy_end用于定义需要重定向的段，</span><br><span class="line"> *    u-boot是一个分为重定向前初始化和重定向后初始化的bootloader，</span><br><span class="line"> *    所以此处会定义在完成重定向前初始化后需要搬运到ddr中数据的起始地址和结束地址；</span><br><span class="line"> *</span><br><span class="line"> *    大多数时候u-boot是运行在受限的sram或者只读的flash上，</span><br><span class="line"> *    u-boot为了启动流程统一会在ddr未初始化和重定位之前不去访问全局变量，</span><br><span class="line"> *    但是又为了保证u-boot能够正常读写全局变量，内存，调用各类驱动能力，</span><br><span class="line"> *    所以u-boot将启动初始化分为了两个部分，重定向前初始化board_f和</span><br><span class="line"> *    重定向后初始化  board_r，在重定向之前完成一些必要初始化，</span><br><span class="line"> *    包括可能的ddr初始化，然后通过__image_copy_start和__image_copy_end</span><br><span class="line"> *    将u-boot搬运到ddr中，并在ddr中进行重定向后初始化，这个时候的u-boot就可以</span><br><span class="line"> *    正常访问全局变量等信息了。</span><br><span class="line"> * </span><br><span class="line"> *    如果想要在board_f过程中读写一些全局变量信息该怎么办呢？</span><br><span class="line"> *    u-boot通过定义global_data（gd）来完成此功能，</span><br><span class="line"> *    后续在分析到时会详细讲解实现方式。</span><br><span class="line"> */</span><br><span class="line">  CPUDIR/start.o (.text*) -------------------------------------------------- (5)</span><br><span class="line">/*</span><br><span class="line"> *（5）定义了链接程序的头部文本段，armv8就是</span><br><span class="line"> *    arch/arm/cpu/armv8/start.S， </span><br><span class="line"> *    start.S中所有文本段将会链接到此段中并且段入口符号就是_start；</span><br><span class="line"> */</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> /* This needs to come before *(.text*) */</span><br><span class="line"> .efi_runtime : &#123; ------------------------------------------------------------ (6)</span><br><span class="line">/*</span><br><span class="line"> *（6）在定义了efi运行时相关支持时才会出现使用的段，一般不用关心；</span><br><span class="line"> */</span><br><span class="line">        __efi_runtime_start = .;</span><br><span class="line">  *(.text.efi_runtime*)</span><br><span class="line">  *(.rodata.efi_runtime*)</span><br><span class="line">  *(.data.efi_runtime*)</span><br><span class="line">        __efi_runtime_stop = .;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> .text_rest : ---------------------------------------------------------------- (7)</span><br><span class="line">/*</span><br><span class="line"> *（7）除了start.o，其他的所有文本段将会链接到此段中；</span><br><span class="line"> */</span><br><span class="line"> &#123;</span><br><span class="line">  *(.text*)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_ARMV8_PSCI -------------------------------------------------------- (8)</span><br><span class="line">/*</span><br><span class="line"> *（8）同（2），是PSCI相关功能的支持，一般不会使用；</span><br><span class="line"> */</span><br><span class="line"> .__secure_start :</span><br><span class="line">#ifndef CONFIG_ARMV8_SECURE_BASE</span><br><span class="line">  ALIGN(CONSTANT(COMMONPAGESIZE))</span><br><span class="line">#endif</span><br><span class="line"> &#123;</span><br><span class="line">  KEEP(*(.__secure_start))</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">#ifndef CONFIG_ARMV8_SECURE_BASE</span><br><span class="line">#define CONFIG_ARMV8_SECURE_BASE</span><br><span class="line">#define __ARMV8_PSCI_STACK_IN_RAM</span><br><span class="line">#endif</span><br><span class="line"> .secure_text CONFIG_ARMV8_SECURE_BASE :</span><br><span class="line">  AT(ADDR(.__secure_start) + SIZEOF(.__secure_start))</span><br><span class="line"> &#123;</span><br><span class="line">  *(._secure.text)</span><br><span class="line">  . = ALIGN(8);</span><br><span class="line">  __secure_svc_tbl_start = .;</span><br><span class="line">  KEEP(*(._secure_svc_tbl_entries))</span><br><span class="line">  __secure_svc_tbl_end = .;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> .secure_data : AT(LOADADDR(.secure_text) + SIZEOF(.secure_text))</span><br><span class="line"> &#123;</span><br><span class="line">  *(._secure.data)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> .secure_stack ALIGN(ADDR(.secure_data) + SIZEOF(.secure_data),</span><br><span class="line">       CONSTANT(COMMONPAGESIZE)) (NOLOAD) :</span><br><span class="line">#ifdef __ARMV8_PSCI_STACK_IN_RAM</span><br><span class="line">  AT(ADDR(.secure_stack))</span><br><span class="line">#else</span><br><span class="line">  AT(LOADADDR(.secure_data) + SIZEOF(.secure_data))</span><br><span class="line">#endif</span><br><span class="line"> &#123;</span><br><span class="line">  KEEP(*(.__secure_stack_start))</span><br><span class="line"></span><br><span class="line">  . = . + CONFIG_ARMV8_PSCI_NR_CPUS * ARM_PSCI_STACK_SIZE;</span><br><span class="line"></span><br><span class="line">  . = ALIGN(CONSTANT(COMMONPAGESIZE));</span><br><span class="line"></span><br><span class="line">  KEEP(*(.__secure_stack_end))</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">#ifndef __ARMV8_PSCI_STACK_IN_RAM</span><br><span class="line"> . = LOADADDR(.secure_stack);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line"> .__secure_end : AT(ADDR(.__secure_end)) &#123;</span><br><span class="line">  KEEP(*(.__secure_end))</span><br><span class="line">  LONG(0x1d1071c); /* Must output something to reset LMA */</span><br><span class="line"> &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line"> . = ALIGN(8);</span><br><span class="line"> .rodata : &#123; *(SORT_BY_ALIGNMENT(SORT_BY_NAME(.rodata*))) &#125; ------------------- (9)</span><br><span class="line">/*</span><br><span class="line"> *（9）所有仅读数据将会在这个段中对齐排序存放好；</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line"> . = ALIGN(8);</span><br><span class="line"> .data : &#123; -------------------------------------------------------------------- (10)</span><br><span class="line">/*</span><br><span class="line"> *（10）所有数据段将会链接到此段中；</span><br><span class="line"> */</span><br><span class="line">  *(.data*)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> . = ALIGN(8);</span><br><span class="line"></span><br><span class="line"> . = .;</span><br><span class="line"></span><br><span class="line"> . = ALIGN(8);</span><br><span class="line"> .u_boot_list : &#123; ------------------------------------------------------------- (11)</span><br><span class="line">/*</span><br><span class="line"> *（11）u_boot_list段定义了系统中当前支持的所有命令和设备驱动，此段把散落在各个文件中</span><br><span class="line"> *     通过U_BOOT_CMD的一系列拓展宏定义的命令和U_BOOT_DRIVER的拓展宏定义的设备驱动收集到一起，</span><br><span class="line"> *     并按照名字排序存放，以便后续在命令行快速检索到命令并执行和检测注册的设备和设备树匹配</span><br><span class="line"> *     probe设备驱动初始化；（设备驱动的probe只在定义了dm模块化驱动时有效）</span><br><span class="line"> */</span><br><span class="line">  KEEP(*(SORT(.u_boot_list*)));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> . = ALIGN(8);</span><br><span class="line"></span><br><span class="line"> .efi_runtime_rel : &#123;</span><br><span class="line">                __efi_runtime_rel_start = .;</span><br><span class="line">  *(.rel*.efi_runtime)</span><br><span class="line">  *(.rel*.efi_runtime.*)</span><br><span class="line">                __efi_runtime_rel_stop = .;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> . = ALIGN(8);</span><br><span class="line"></span><br><span class="line"> .image_copy_end :</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__image_copy_end)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> . = ALIGN(8);</span><br><span class="line"></span><br><span class="line"> .rel_dyn_start : -------------------------------------------------------- (12)</span><br><span class="line">/*</span><br><span class="line"> *（12）一般u-boot运行时是根据定义的基地址开始执行，如果加载地址和链接地址</span><br><span class="line"> *     不一致则会出现不能执行u-boot的问题。通过一个</span><br><span class="line"> *     配置CONFIG_POSITION_INDEPENDENT即可打开地址无关功能，</span><br><span class="line"> *     此选项会在链接u-boot时添加-PIE参数。此参数会在u-boot ELF文件中</span><br><span class="line"> *     生成rela*段，u-boot通过读取此段中表的相对地址值与实际运行时地址值</span><br><span class="line"> *     依次遍历进行修复当前所有需要重定向地址，使其可以实现地址无关运行；</span><br><span class="line"> *     即无论链接基地址如何定义，u-boot也可以在任意ram地址</span><br><span class="line"> *     运行（一般需要满足最低4K或者64K地址对齐）；</span><br><span class="line"> * </span><br><span class="line"> *     注意此功能只能在sram上实现，因为此功能会在运行时修改文本段数据段中的地址，</span><br><span class="line"> *     如果此时运行在片上flash，则不能写flash，导致功能失效无法实现地址无关；</span><br><span class="line"> */</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__rel_dyn_start)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> .rela.dyn : &#123;</span><br><span class="line">  *(.rela*)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> .rel_dyn_end :</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__rel_dyn_end)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> _end = .;</span><br><span class="line"></span><br><span class="line"> . = ALIGN(8);</span><br><span class="line"></span><br><span class="line"> .bss_start : &#123; -------------------------------------------------------- (13)</span><br><span class="line">/*</span><br><span class="line"> *（13）众所周知的bbs段；</span><br><span class="line"> */</span><br><span class="line">  KEEP(*(.__bss_start));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> .bss : &#123;</span><br><span class="line">  *(.bss*)</span><br><span class="line">   . = ALIGN(8);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> .bss_end : &#123;</span><br><span class="line">  KEEP(*(.__bss_end));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> /DISCARD/ : &#123; *(.dynsym) &#125; -------------------------------------------- (14)</span><br><span class="line">/*</span><br><span class="line"> *（14）一些在链接时无用需要丢弃的段；</span><br><span class="line"> */</span><br><span class="line"> /DISCARD/ : &#123; *(.dynstr*) &#125;</span><br><span class="line"> /DISCARD/ : &#123; *(.dynamic*) &#125;</span><br><span class="line"> /DISCARD/ : &#123; *(.plt*) &#125;</span><br><span class="line"> /DISCARD/ : &#123; *(.interp*) &#125;</span><br><span class="line"> /DISCARD/ : &#123; *(.gnu*) &#125;</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_LINUX_KERNEL_IMAGE_HEADER ----------------------------------- (15)</span><br><span class="line">/*</span><br><span class="line"> *（15）在efi加载时会很有用，主要在u-boot的二进制头部添加了一些头部信息，</span><br><span class="line"> *     包括大小端，数据段文本段大小等，以便于efi相关的加载器读取信息，</span><br><span class="line"> *     此头部信息来自于Linux arm64的Image的头部信息；该头部也不属于u-boot的</span><br><span class="line"> *     一部分只是被附加上去的；</span><br><span class="line"> */</span><br><span class="line">#include &quot;linux-kernel-image-header-vars.h&quot;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ECTIONS表示正式开始地址划分</p>
<p>.的意思是当前地址，这句将当前地址（代码段起始地址）设为0x00000000，但是其实这个地址会被config.mk用-Ttext $(TEXT_BASE)指定的虚拟地址0x80800000(&#x2F;board&#x2F;hi3521a&#x2F;config.mk中定义)覆盖掉</p>
<h1 id="3-第一阶段"><a href="#3-第一阶段" class="headerlink" title="3.第一阶段"></a>3.第一阶段</h1><p>armv8启动流程：</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172706081.png" alt="image-20250428172706081"></p>
<p>uboot第一阶段从start.s开始 是汇编实现，通过uboot.lds文件可以找到 入口的entry</p>
<h2 id="代码流程"><a href="#代码流程" class="headerlink" title="代码流程"></a>代码流程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">_start        arch/arm/cpu/armv8/start.S</span><br><span class="line">    reset:</span><br><span class="line">        save_boot_params_ret</span><br><span class="line">            lowlevel_init (非pdl sdl spl构建时执行低级初始化 ​GIC（中断控制器）初始化 ​多核 CPU 启动同步 特定 SoC 的早期硬件初始化)</span><br><span class="line">            bl _main       arch/arm/lib/crt0_64.S</span><br><span class="line">                /*先获取uboot的初始栈 */</span><br><span class="line">               board_init_f_alloc_reserve  common/init/board_init.c  //为gd和early malloc设置地址</span><br><span class="line">               board_init_f_init_reserve    //初始化gd 和设置early malloc的堆管理器基地址</span><br><span class="line">               </span><br><span class="line">               board_init_f  common/board_f.c    common/board_f.c            </span><br><span class="line">                   initcall_run_list(init_sequence_f) 遍历init_sequence_f中的初始化回调函数 并执行</span><br><span class="line">                       setup_mon_len  设置 gd 的 mon_len 成员变量，整个代码的长度</span><br><span class="line">                       fdtdec_setup    获取设备树地址</span><br><span class="line">                       initf_malloc    设置gd 的malloc_limit，malloc内存池大小 CONFIG_SYS_MALLOC_F_LEN=0x2000</span><br><span class="line">                       arch_cpu_init    硬件 CPU初始化</span><br><span class="line">                       mach_cpu_init    特定SoC的初始化</span><br><span class="line">                       initf_dm，arch_cpu_init_dm：DM驱动模型的一些初始化</span><br><span class="line">                       get_clocks        获取一些时钟值</span><br><span class="line">                       timer_init    初始化定时器，为 uboot 提供时间</span><br><span class="line">                       env_init    设置 gd 的成员变量 env_addr，也就是环境变量的保存地址</span><br><span class="line">                       init_baud_rate 初始化波特率</span><br><span class="line">                       serial_init：初始化串口</span><br><span class="line">                       console_init_f 控制台初始化阶段1</span><br><span class="line">                       display_text_info 打印调试信息</span><br><span class="line">                   --执行init_sequence力度函数 初始化cpu DM驱动模型，内核定时器 波特率 串口 可以在serial_init里加一句初始化</span><br><span class="line">                /*relocate_code之前将调整gd的位置，保存 relocation_return的地址 记录重定位后的汇编代码地址用于跳转*/</span><br><span class="line">                relocate_code \\用于拷贝代码到sram， arch/arm/lib/relocate.S</span><br><span class="line">                </span><br><span class="line">                c_runtime_cpu_setup   非spl 这个函数也很简单，就是如果使能了ICache，则将缓存中的所有有效数据标记为无效，这意味着下次访问这些数据时，系统将不会从缓存中读取。</span><br><span class="line">                spl_relocate_stack_gd uboot已经在relocate_code中被拷贝到ram中了，还需要重定位spl 的gd栈。这个函数功能就是计算栈的位置，使用memcpy将gd结构拷贝给一个新的gd结构，并返回新的gd栈指针</span><br><span class="line">                /*clear bss section 清除bss端*/</span><br><span class="line">                ldr	x0, =__bss_start		/* this is auto-relocated! */</span><br><span class="line">	            ldr	x1, =__bss_end			/* this is auto-relocated! */</span><br><span class="line">        clear_loop:</span><br><span class="line">	            str	xzr, [x0], #8</span><br><span class="line">	            cmp	x0, x1</span><br><span class="line">	            b.lo	clear_loop</span><br><span class="line">                board_init_r  进入到第二阶段的启动                            </span><br></pre></td></tr></table></figure>

<h2 id="重要知识点"><a href="#重要知识点" class="headerlink" title="重要知识点"></a>重要知识点</h2><h3 id="global-data"><a href="#global-data" class="headerlink" title="global_data"></a>global_data</h3><p>gd是全局数据结构 include&#x2F;asm-generic&#x2F;global_data.h 具体字段因架构而异 用于存储关键信息 bd是gd中的板级数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> &#123;</span></span><br><span class="line">    <span class="type">bd_t</span> *bd;               <span class="comment">// 板级数据（Board Data）</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;    <span class="comment">// 状态标志</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> baudrate;  <span class="comment">// 串口波特率</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> cpu_clk;  <span class="comment">// CPU 频率</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ram_size; <span class="comment">// RAM 大小</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> env_addr; <span class="comment">// 环境变量地址</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> relocaddr; <span class="comment">// U-Boot 重定位地址</span></span><br><span class="line">    <span class="comment">// ... 其他字段</span></span><br><span class="line">&#125; <span class="type">gd_t</span>;</span><br></pre></td></tr></table></figure>

<h3 id="uboot重定位"><a href="#uboot重定位" class="headerlink" title="uboot重定位"></a>uboot重定位</h3><p><strong>谓的relocation，就是重定位，uboot运行后会将自身代码拷贝到sdram的另一个位置继续运行</strong>，这个在uboot启动流程分析中说过。</p>
<p><strong>但基于以前的理解，一个完整可运行的bin文件，link时指定的链接地址，load时的加载地址，运行时的运行地址，这3个地址应该是一致的</strong></p>
<p><strong>relocation后运行地址不同于加载地址 特别是链接地址，ARM的寻址会不会出现问题？</strong></p>
<p>新版uboot跟老版uboot不太一样的地方在于新版uboot不管uboot的load addr（entry pointer）在哪里，启动后会计算出一个靠近sdram顶端的地址，将自身代码拷贝到该地址，继续运行。</p>
<p><strong>个人感觉uboot这样改进用意有二，一是为kernel腾出低端空间，防止kernel解压覆盖uboot，二是对于由静态存储器（spiflash nandflash）启动，这个relocation是必须的。</strong></p>
<p>但是这样会有一个问题，relocation后uboot的运行地址跟其链接地址不一致，compiler会在link时确定了其中变量以及函数的绝对地址，链接地址 加载地址 运行地址应该一致，</p>
<p>详解：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/520060653">https://zhuanlan.zhihu.com/p/520060653</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#if defined(CONFIG_TPL_BUILD) &amp;&amp; defined(CONFIG_TPL_NEEDS_SEPARATE_STACK)</span><br><span class="line">	ldr	x0, =(CONFIG_TPL_STACK)</span><br><span class="line">#elif defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span><br><span class="line">	ldr	x0, =(CONFIG_SPL_STACK)</span><br><span class="line">#elif defined(CONFIG_INIT_SP_RELATIVE)</span><br><span class="line">#if CONFIG_POSITION_INDEPENDENT</span><br><span class="line">	adrp	x0, __bss_start</span><br><span class="line">	add	x0, x0, #:lo12:__bss_start</span><br><span class="line">#else</span><br><span class="line">	adr	x0, __bss_start</span><br><span class="line">#endif</span><br><span class="line">	add	x0, x0, #CONFIG_SYS_INIT_SP_BSS_OFFSET</span><br><span class="line">#else</span><br><span class="line">	ldr	x0, =(CONFIG_SYS_INIT_SP_ADDR)                         （1）</span><br><span class="line">#endif</span><br><span class="line">	bic	sp, x0, #0xf                                           （2）</span><br><span class="line">	mov	x0, sp                                                  </span><br><span class="line">	bl	board_init_f_alloc_reserve                             （3）</span><br><span class="line">	mov	sp, x0                                                 （4）</span><br><span class="line">	mov	x18, x0                                                （5）</span><br><span class="line">	bl	board_init_f_init_reserve                              （6）	</span><br></pre></td></tr></table></figure>

<p>1）以上部分根据不同的配置情况获取uboot的初始栈地址</p>
<p>（2）为了遵循ABI规范，栈地址需要16字节对齐，该指令将地址做对齐以后设置到栈指针寄存器中，以为系统设置运行栈</p>
<p>（3）该函数为gd和early malloc分配内存，其代码如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ulong board_init_f_alloc_reserve(ulong top)</span><br><span class="line">&#123;</span><br><span class="line">#if CONFIG_VAL(SYS_MALLOC_F_LEN)</span><br><span class="line">        top -= CONFIG_VAL(SYS_MALLOC_F_LEN);                         （a）</span><br><span class="line">#endif</span><br><span class="line">        top = rounddown(top-sizeof(struct global_data), 16);         （b）</span><br><span class="line">        return top;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　a 为早期堆管理器预留内存</p>
<p>　　b 为gd预留内存</p>
<p>（4）将预留后的内存地址设置为新的栈地址，此时各部分的地址如下：</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172728156.png" alt="image-20250428172728156"></p>
<p>（5）将gd地址保存到x18寄存器中，其可用被于后续gd指针的获取</p>
<p>（6）该流程主要用于初始化gd，和设置early malloc的堆管理器基地址，其代码如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">void board_init_f_init_reserve(ulong base)</span><br><span class="line">&#123;</span><br><span class="line">        struct global_data *gd_ptr;</span><br><span class="line"></span><br><span class="line">        gd_ptr = (struct global_data *)base;</span><br><span class="line">        memset(gd_ptr, &#x27;\0&#x27;, sizeof(*gd));                                       （a）</span><br><span class="line">#if !defined(CONFIG_ARM)</span><br><span class="line">        arch_setup_gd(gd_ptr);                                                   （b）</span><br><span class="line">#endif</span><br><span class="line">        if (CONFIG_IS_ENABLED(SYS_REPORT_STACK_F_USAGE))</span><br><span class="line">                board_init_f_init_stack_protection_addr(base);                   （c）</span><br><span class="line">        base += roundup(sizeof(struct global_data), 16);                               </span><br><span class="line">#if CONFIG_VAL(SYS_MALLOC_F_LEN)</span><br><span class="line">        gd-&gt;malloc_base = base;                                                  （d）</span><br><span class="line">#endif</span><br><span class="line">        if (CONFIG_IS_ENABLED(SYS_REPORT_STACK_F_USAGE))</span><br><span class="line">                board_init_f_init_stack_protection();                            （e）</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　a 获取gd指针，并清空gd结构体内存</p>
<p>　　b 该函数用于非arm架构的gd指针获取，armv8架构则通过前面设置的x18寄存器获取gd指针，其定义如下（arch&#x2F;arm&#x2F;include&#x2F;asm&#x2F;global_data.h</p>
<p>）：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#ifdef CONFIG_ARM64</span><br><span class="line">#define DECLARE_GLOBAL_DATA_PTR         register volatile gd_t *gd asm (&quot;x18&quot;)</span><br><span class="line">#else</span><br><span class="line">#define DECLARE_GLOBAL_DATA_PTR         register volatile gd_t *gd asm (&quot;r9&quot;)</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>　　c 该函数用于获取该栈溢出检测的地址</p>
<p>　　d 设置early malloc的基地址</p>
<p>　　e 初始化栈溢出检测的canary值，该值被设置为SYS_STACK_F_CHECK_BYTE</p>
<p>由于内核需要从内存的低地址开始运行，为了防止内核三件套（kernel、dtb和ramdisk）的加载地址与uboot运行地址重叠，因此uboot的重定位地址需要被设置到内存顶端附近。同时我们还需要为一些特定模块预留一些内存空间（比如页表空间、framebuffer等），下图就是uboot规划的重定位后内存布局：</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172748045.png" alt="image-20250428172748045"></p>
<p>代码解析：重定位前的主板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ldr	x0, [x18, #GD_START_ADDR_SP]	/* x0 &lt;- gd-&gt;start_addr_sp */ 将gdd的栈启使地址 给x0</span><br><span class="line">bic	sp, x0, #0xf	/* 16-byte alignment for ABI compliance */  x016字节对齐-》栈指针</span><br><span class="line">ldr	x18, [x18, #GD_BD]		/* x18 &lt;- gd-&gt;bd */  加载gd的bd指针给x18</span><br><span class="line">sub	x18, x18, #GD_SIZE		/* new GD is below bd */ 将新的gd放在bd的地址之下</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   adr	lr, relocation_return  /*存储relocationg_return标签的地址*?</span><br><span class="line">ldr	x9, [x18, #GD_RELOC_OFF]	/* x9 &lt;- gd-&gt;reloc_off */   读取偏移量</span><br><span class="line">add	lr, lr, x9	/* new return address after relocation */ 根据重定位偏移调整lr的位置</span><br><span class="line">ldr	x0, [x18, #GD_RELOCADDR]	/* x0 &lt;- gd-&gt;relocaddr */ 将冲低昂为地址传给x0</span><br><span class="line">b	relocate_code  进入重定位 更具x0的地址 将镜像拷贝到重定位的位置</span><br><span class="line">relocation_return: </span><br><span class="line">    .........</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(relocate_code)</span><br><span class="line">	stp	x29, x30, [sp, #-32]!</span><br><span class="line">	mov	x29, sp</span><br><span class="line">	str	x0, [sp, #16]                           （1） </span><br><span class="line"></span><br><span class="line">	adrp	x1, __image_copy_start</span><br><span class="line">	add	x1, x1, :lo12:__image_copy_start         </span><br><span class="line">	subs	x9, x0, x1			                 </span><br><span class="line">	b.eq	relocate_done	                        （2）</span><br><span class="line">	ldr	x1, _TEXT_BASE	</span><br><span class="line">	subs	x9, x0, x1                              （3）</span><br><span class="line"></span><br><span class="line">	adrp	x1, __image_copy_start	</span><br><span class="line">	add	x1, x1, :lo12:__image_copy_start</span><br><span class="line">	adrp	x2, __image_copy_end</span><br><span class="line">	add	x2, x2, :lo12:__image_copy_end          （4）</span><br><span class="line">copy_loop:                                              （5）</span><br><span class="line">	ldp	x10, x11, [x1], #16</span><br><span class="line">	stp	x10, x11, [x0], #16</span><br><span class="line">	cmp	x1, x2</span><br><span class="line">	b.lo	copy_loop          </span><br><span class="line">	str	x0, [sp, #24]                           （6）</span><br><span class="line"></span><br><span class="line">	adrp	x2, __rel_dyn_start	                （7）</span><br><span class="line">	add	x2, x2, :lo12:__rel_dyn_start	</span><br><span class="line">	adrp	x3, __rel_dyn_end	</span><br><span class="line">	add	x3, x3, :lo12:__rel_dyn_end</span><br><span class="line">fixloop:</span><br><span class="line">	ldp	x0, x1, [x2], #16</span><br><span class="line">	ldr	x4, [x2], #8</span><br><span class="line">	and	x1, x1, #0xffffffff</span><br><span class="line">	cmp	x1, #R_AARCH64_RELATIVE</span><br><span class="line">	bne	fixnext</span><br><span class="line"></span><br><span class="line">	add	x0, x0, x9</span><br><span class="line">	add	x4, x4, x9</span><br><span class="line">	str	x4, [x0]</span><br><span class="line">fixnext:</span><br><span class="line">	cmp	x2, x3</span><br><span class="line">	b.lo	fixloop</span><br><span class="line"></span><br><span class="line">relocate_done:</span><br><span class="line">	switch_el x1, 3f, 2f, 1f                       （8）</span><br><span class="line">	bl	hang</span><br><span class="line">3:	mrs	x0, sctlr_el3</span><br><span class="line">	b	0f</span><br><span class="line">2:	mrs	x0, sctlr_el2</span><br><span class="line">	b	0f</span><br><span class="line">1:	mrs	x0, sctlr_el1</span><br><span class="line">0:	tbz	w0, #2, 5f                             （9）</span><br><span class="line">	tbz	w0, #12, 4f                            （10）</span><br><span class="line">	ic	iallu	</span><br><span class="line">	isb	sy</span><br><span class="line">4:	ldp	x0, x1, [sp, #16]</span><br><span class="line">	bl	__asm_flush_dcache_range</span><br><span class="line">	bl     __asm_flush_l3_dcache</span><br><span class="line">5:	ldp	x29, x30, [sp],#32                     （11）</span><br><span class="line">	Ret                                            （12）</span><br><span class="line">ENDPROC(relocate_code)</span><br></pre></td></tr></table></figure>

<p>（1）构造一个栈帧，该栈帧中包含lr寄存器x30，fp寄存器x29和函数入参x0，其中x0为重定位的起始目的地址，该流程之后栈帧的内容如下：</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172810138.png" alt="image-20250428172810138"></p>
<p>（2）计算镜像运行地址与目的地址的偏移，若它们相等，则显然无须执行重定位，可直接跳过该流程</p>
<p>（3）计算镜像链接地址与目的地址的偏移</p>
<p>（4）读取镜像运行地址的起始地址和结束地址</p>
<p>（5）从运行地址处将镜像拷贝到重定位目的地址处</p>
<p>（6）将重定位结束地址入栈，入栈后栈帧的内容如下：</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172818333.png" alt="image-20250428172818333"></p>
<p>（7）位置无关代码相关处理</p>
<p>（8）根据当前执行的异常等级，跳转到对应的位置以读取sctlr寄存器的内容</p>
<p>（9 - 10）由于重定位后pc将会跳转到新的位置执行，因此若使能了cache，显然重定位之前已加载到cache中的指令还是老的地址，此时若直接跳转则cache中的内容是错误的。因此必须要失效掉cache中已经加载的内容</p>
<p>（11）从栈帧中恢复x29和x30（lr）的内容。现在已经万事俱备，只欠东风了，我们只要通过ret命令跳转到新地址执行即可</p>
<p>（12）经过慢慢长途，让我们在新的位置愉快地继续奔跑吧</p>
<h3 id="init-sequence-f-函数数组"><a href="#init-sequence-f-函数数组" class="headerlink" title="init_sequence_f[] 函数数组"></a>init_sequence_f[] 函数<strong>数组</strong></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">init_fnc_t</span> init_sequence_f[] = &#123;</span><br><span class="line">	setup_mon_len,</span><br><span class="line">	fdtdec_setup,</span><br><span class="line"> </span><br><span class="line">	initf_malloc,</span><br><span class="line">	log_init,</span><br><span class="line">	initf_bootstage,	<span class="comment">/* uses its own timer, so does not need DM */</span></span><br><span class="line"> </span><br><span class="line">	setup_spl_handoff,</span><br><span class="line"> </span><br><span class="line">	arch_cpu_init,		<span class="comment">/* basic arch cpu dependent setup */</span></span><br><span class="line">	mach_cpu_init,		<span class="comment">/* SoC/machine dependent CPU setup */</span></span><br><span class="line">	initf_dm,</span><br><span class="line">	arch_cpu_init_dm,</span><br><span class="line"> </span><br><span class="line">	get_clocks,		<span class="comment">/* get CPU and bus clocks (etc.) */</span></span><br><span class="line"> </span><br><span class="line">	board_postclk_init,</span><br><span class="line"> </span><br><span class="line">	env_init,		<span class="comment">/* initialize environment */</span></span><br><span class="line">	init_baud_rate,		<span class="comment">/* initialze baudrate settings */</span></span><br><span class="line">	serial_init,		<span class="comment">/* serial communications setup */</span></span><br><span class="line">	console_init_f,		<span class="comment">/* stage 1 init of console */</span></span><br><span class="line">	display_options,	<span class="comment">/* say that we are here */</span></span><br><span class="line">	display_text_info,	<span class="comment">/* show debugging info if required */</span></span><br><span class="line">	checkcpu,</span><br><span class="line"> </span><br><span class="line">	announce_dram_init,</span><br><span class="line">	dram_init,		<span class="comment">/* configure available RAM banks */</span></span><br><span class="line"> </span><br><span class="line">	testdram,</span><br><span class="line">	</span><br><span class="line">	setup_dest_addr,</span><br><span class="line"> </span><br><span class="line">	reserve_pram,</span><br><span class="line"> </span><br><span class="line">	reserve_round_4k,</span><br><span class="line">	arch_reserve_mmu,</span><br><span class="line">	reserve_video,</span><br><span class="line">	reserve_trace,</span><br><span class="line">	reserve_uboot,</span><br><span class="line">	reserve_malloc,</span><br><span class="line">	reserve_board,</span><br><span class="line">	reserve_global_data,</span><br><span class="line">	reserve_fdt,</span><br><span class="line">	reserve_bootstage,</span><br><span class="line">	reserve_bloblist,</span><br><span class="line">	reserve_arch,</span><br><span class="line">	reserve_stacks,</span><br><span class="line">	dram_init_banksize,</span><br><span class="line">	show_dram_config,</span><br><span class="line"> </span><br><span class="line">	setup_bdinfo,</span><br><span class="line">	display_new_sp,</span><br><span class="line"> </span><br><span class="line">	reloc_fdt,</span><br><span class="line">	reloc_bootstage,</span><br><span class="line">	reloc_bloblist,</span><br><span class="line">	setup_reloc,</span><br><span class="line"> </span><br><span class="line">	clear_bss,</span><br><span class="line"> </span><br><span class="line">	<span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="4-第二阶段"><a href="#4-第二阶段" class="headerlink" title="4.第二阶段"></a>4.第二阶段</h1><h2 id="代码流程-1"><a href="#代码流程-1" class="headerlink" title="代码流程"></a>代码流程</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">board_init_r     common/board_r.<span class="function">c</span></span><br><span class="line"><span class="function">    <span class="title">board_init_r</span><span class="params">(common/board_r.c)</span><span class="comment">/*板级初始化*/</span></span></span><br><span class="line"><span class="function">        <span class="title">initcall_run_list</span><span class="params">(include/initcall.h)</span><span class="comment">/*初始化序列函数*/</span></span></span><br><span class="line"><span class="function">            init_sequence_r[]<span class="params">(common/board_f.c)</span><span class="comment">/*序列函数*/</span></span></span><br><span class="line"><span class="function">            initr_trace,</span></span><br><span class="line"><span class="function">	        initr_reloc,</span></span><br><span class="line"><span class="function">	        <span class="comment">/* <span class="doctag">TODO:</span> could x86/PPC have this also perhaps? */</span></span></span><br><span class="line"><span class="function">            <span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM</span></span></span><br><span class="line"><span class="function">	        initr_caches,</span></span><br><span class="line"><span class="function">            initr_barrier,</span></span><br><span class="line"><span class="function">	        initr_malloc,</span></span><br><span class="line"><span class="function">	        initr_bootstage,	<span class="comment">/* Needs malloc() but has its own timer */</span></span></span><br><span class="line"><span class="function">	        initr_console_record</span></span><br><span class="line"><span class="function">            ........... </span></span><br><span class="line"><span class="function">    run_main_loop         common/board_r.c</span></span><br><span class="line"><span class="function">        <span class="title">boot_logo</span><span class="params">()</span> <span class="comment">/*显示logo*/</span></span></span><br><span class="line"><span class="function">        main_loop        common/main.c</span></span><br><span class="line"><span class="function">             <span class="comment">/*hush shell初始化*/</span></span></span><br><span class="line"><span class="function">            cli_init</span></span><br><span class="line"><span class="function">            <span class="comment">/* 处理延时参数 */</span>    </span></span><br><span class="line"><span class="function">            <span class="title">bootdelay_process</span><span class="params">()</span></span>;</span><br><span class="line">                s = <span class="built_in">env_get</span>(<span class="string">&quot;bootdelay&quot;</span>); 从gd中找bootdelay参数</span><br><span class="line">                bootdelay = s ? (<span class="type">int</span>)<span class="built_in">simple_strtol</span>(s, <span class="literal">NULL</span>, <span class="number">10</span>) : CONFIG_BOOTDELAY;</span><br><span class="line">                <span class="comment">//初始化环境变量的时间</span></span><br><span class="line">                <span class="built_in">run_preboot_environment_command</span>();</span><br><span class="line">                <span class="built_in">debug</span>(<span class="string">&quot;### main_loop entered: bootdelay=%d\n\n&quot;</span>, bootdelay);  <span class="comment">//这里打印bootdelay</span></span><br><span class="line">                s = <span class="built_in">env_get</span>(<span class="string">&quot;bootcmd&quot;</span>); <span class="comment">//获取bootcmd</span></span><br><span class="line">                <span class="comment">//CONFIG_OF_CONTROL 开启 处理设备树中的&quot;kernel-offset&quot; &quot;rootdisk-offset&quot;两个属性 并设置 环境变量kernaddr kernaddr</span></span><br><span class="line">                process_fdt_options</span><br><span class="line">                </span><br><span class="line">            cli_process_fdt   <span class="comment">//解析设备树中bootcmd用于动态修改默认cmd 并检查是否配置安全启动           </span></span><br><span class="line">                <span class="built_in">cli_secure_boot_cmd</span>(s);<span class="comment">//安全启动</span></span><br><span class="line">            <span class="built_in">autoboot_command</span>(s);</span><br><span class="line">            <span class="built_in">debug</span>(<span class="string">&quot;### main_loop: bootcmd=\&quot;%s\&quot;\n&quot;</span>, s ? s : <span class="string">&quot;&lt;UNDEFINED&gt;&quot;</span>);</span><br><span class="line">                __abortboot()  \\中断检测用户按键 用于终止自动启动</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;Hit any key to stop autoboot: %2d &quot;</span>, bootdelay);\\倒计时</span><br><span class="line">                <span class="built_in">run_command_list</span>() \\用户未终止则执行boot命令 调用 hush shell执行booti命令 加载内核</span><br><span class="line">                    <span class="built_in">cli_simple_run_command_list</span>()  common/cli_simple.<span class="function">c</span></span><br><span class="line"><span class="function">                        <span class="title">cli_simple_run_command</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">                            <span class="title">cmd_process</span><span class="params">()</span>     common/command.c</span></span><br><span class="line"><span class="function">                                <span class="title">find_cmd</span><span class="params">(argv[<span class="number">0</span>])</span></span>; <span class="comment">/* 在命令表中查找命令  通过hash map 快速匹配  mmc booti等命令的cmd_tbl_s结构体*/</span></span><br><span class="line">                                <span class="built_in">cmd_call</span>(cmdtp, flag, argc, argv);  <span class="comment">//执行 cmdtp-&gt; cmd</span></span><br><span class="line">            <span class="built_in">cli_loop</span>() \\用户按键中断后执行 用户循环 hush shell 输入指令 然后执行指令</span><br><span class="line">                <span class="built_in">cli_simple_loop</span>();</span><br><span class="line">                    cli_readline</span><br><span class="line">                        run_command_repeatable</span><br><span class="line">                            cli_simple_run_command</span><br><span class="line">                            .....</span><br><span class="line">                               <span class="built_in">cmd_process</span>()     common/command.c </span><br><span class="line">                                                                                                       </span><br><span class="line">                                                                                                                                                                                          </span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                </span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h2 id="重要知识点-1"><a href="#重要知识点-1" class="headerlink" title="重要知识点"></a>重要知识点</h2><h3 id="cmd-tbl-s-cmd结构体"><a href="#cmd-tbl-s-cmd结构体" class="headerlink" title="cmd_tbl_s cmd结构体"></a>cmd_tbl_s cmd结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cmd_tbl_s</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *name;                 <span class="comment">// 命令名（如 &quot;bootm&quot;）</span></span><br><span class="line">    <span class="type">int</span> maxargs;                <span class="comment">// 最大参数个数</span></span><br><span class="line">    <span class="type">int</span> repeatable;             <span class="comment">// 是否可重复执行</span></span><br><span class="line">    <span class="type">int</span> (*cmd)(<span class="keyword">struct</span> cmd_tbl_s *, <span class="type">int</span>, <span class="type">int</span>, <span class="type">char</span> * <span class="type">const</span> []); <span class="comment">// 命令函数指针</span></span><br><span class="line">    <span class="comment">// ... 其他字段 ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>bootm命令的注册</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">U_BOOT_CMD(bootm, CONFIG_SYS_MAXARGS, <span class="number">1</span>, do_bootm, <span class="string">&quot;Boot an image&quot;</span>, bootm_help_text);</span><br></pre></td></tr></table></figure>

<h1 id="5-uboot-DM驱动模型"><a href="#5-uboot-DM驱动模型" class="headerlink" title="5.uboot DM驱动模型"></a>5.uboot DM驱动模型</h1><h2 id="1-数据结构"><a href="#1-数据结构" class="headerlink" title="1.数据结构"></a>1.数据结构</h2><p>主要包含 uclass udevice udriver</p>
<p>uclass又包含 uclass driver 用于描述总线的驱动 包含uclass总线运行的方法，重点关注post_bind post_probe</p>
<p>uclass会维护一个设备链表，存储绑定的设备，绑定的设备中可以找到绑定的drv</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172838883.png" alt="image-20250428172838883"></p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172838883.png"></p>
<p>UBOOT最重要的数据结构gd中，与dm相关的成员如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">typedef struct global_data &#123;</span><br><span class="line">   // dts中的根节点，第一个创建的udevice</span><br><span class="line">   struct udevice  *dm_root;</span><br><span class="line"></span><br><span class="line">   // relocation之前的根设备</span><br><span class="line">   struct udevice  *dm_root_f;</span><br><span class="line"></span><br><span class="line">  // uclass的链表, 挂的是有udevice的uclass</span><br><span class="line">   struct list_head uclass_root;  </span><br><span class="line">&#125; gd_t;</span><br></pre></td></tr></table></figure>

<h2 id="2-模型解析"><a href="#2-模型解析" class="headerlink" title="2.模型解析"></a>2.模型解析</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> U_BOOT_DRIVER(__name) \</span></span><br><span class="line"><span class="meta">ll_entry_declare(struct driver, __name, driver)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> U_BOOT_DEVICE(__name) \</span></span><br><span class="line"><span class="meta">ll_entry_declare(struct driver_info, __name, driver_info)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ll_entry_declare(_type, _name, _list) \</span></span><br><span class="line"><span class="meta">_type _u_boot_list_2_##_list##_2_##_name __aligned(4) \</span></span><br><span class="line"><span class="meta">__attribute__((unused, \</span></span><br><span class="line"><span class="meta">section(<span class="string">&quot;.u_boot_list_2_&quot;</span>#_list<span class="string">&quot;_2_&quot;</span>#_name)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Declare a new uclass_driver */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCLASS_DRIVER(__name) \</span></span><br><span class="line"><span class="meta">ll_entry_declare(struct uclass_driver, __name, uclass)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ll_entry_declare(_type, _name, _list) \</span></span><br><span class="line"><span class="meta">_type _u_boot_list_2_##_list##_2_##_name __aligned(4) \</span></span><br><span class="line"><span class="meta">__attribute__((unused, \</span></span><br><span class="line"><span class="meta">section(<span class="string">&quot;.u_boot_list_2_&quot;</span>#_list<span class="string">&quot;_2_&quot;</span>#_name)))</span></span><br></pre></td></tr></table></figure>

<h3 id="1-dm驱动框架的初始化"><a href="#1-dm驱动框架的初始化" class="headerlink" title="1.dm驱动框架的初始化"></a>1.dm驱动框架的初始化</h3><h4 id="代码流程-2"><a href="#代码流程-2" class="headerlink" title="代码流程"></a>代码流程</h4><p>在root.c中 注册了<strong>root</strong> uclass driver 和 <strong>root_driver</strong> uboot driver</p>
<p><img src="/uboot/WEBRESOURCEddd20cbf670c43a5be75ac90fcdcd681image.png"></p>
<p>在第一阶段 的 init_borad_f中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">borad_init_f()  common/board_f.c</span><br><span class="line">    <span class="title function_">initcall_run_list</span><span class="params">(<span class="type">const</span> <span class="type">init_fnc_t</span> init_sequence[])</span></span><br><span class="line">        init_sequence_f</span><br><span class="line">            initf_dm             </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">initf_dm() common/board_f.c</span><br><span class="line">    dm_init_and_scan</span><br><span class="line">        <span class="title function_">dm_init</span><span class="params">(IS_ENABLED(CONFIG_OF_LIVE))</span>;  创建udevice和uclass空链表，创建根设备（root device）</span><br><span class="line">            INIT_LIST_HEAD(&amp;DM_UCLASS_ROOT_NON_CONST); 创建uclass空链表 第一个节点是 gd-&gt;uclass</span><br><span class="line">            <span class="title function_">device_bind_by_name</span><span class="params">(<span class="literal">NULL</span>, <span class="literal">false</span>, &amp;root_info, &amp;DM_ROOT_NON_CONST)</span>; drivers/core/device.c 创建一个device并将其绑定到driver，这是一个帮助器函数，用于绑定不使用设备树的设备。</span><br><span class="line">            <span class="comment">/*  #define DM_ROOT_NON_CONST		(((gd_t *)gd)-&gt;dm_root)</span></span><br><span class="line"><span class="comment">                #define DM_UCLASS_ROOT_NON_CONST	(((gd_t *)gd)-&gt;uclass_root)</span></span><br><span class="line"><span class="comment">                static const struct driver_info root_info = &#123;</span></span><br><span class="line"><span class="comment">            	    .name		= &quot;root_driver&quot;,</span></span><br><span class="line"><span class="comment">                 &#125;;*/</span></span><br><span class="line">                lists_driver_lookup_name(info-&gt;name); drivers/core/lists.c <span class="comment">// 通过driver name “root_driver”遍历整个driver list，找到U_BOOT_DRIVER(root_driver)定义的driver地址</span></span><br><span class="line">                device_bind_common  <span class="comment">// 创建udevice dm_root和uclass root，并将driver root_driver、udevice dm_root和uclass root三者进行绑定。</span></span><br><span class="line">                    uclass_get() 根据id从uclass链表中招到uclass节点，没有的话就创建一个 这里创建了id为<span class="number">0</span>的 root <span class="class"><span class="keyword">class</span> </span></span><br><span class="line"><span class="class">                    <span class="title">dev</span> =</span> <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> udevice)); <span class="comment">//创建 dm_root udevice设备</span></span><br><span class="line">                    dev-&gt;platdata = platdata;</span><br><span class="line">	                dev-&gt;driver_data = driver_data;</span><br><span class="line">	                dev-&gt;name = name;</span><br><span class="line">                    dev-&gt;driver = drv; \\绑定uroot drv </span><br><span class="line">                    dev-&gt;uclass = uc;   \\绑定root uclass                                                                   </span><br><span class="line">                    ......填充dev成员</span><br><span class="line">                    uclass_bind_device(dev) <span class="comment">//将device与 uclass绑定 将dev-&gt;uclass_node填充到 uc-&gt;dev_head链表</span></span><br><span class="line">                    ret = drv-&gt;bind(dev); <span class="comment">//执行driver的bind行数绑定 root未实现</span></span><br><span class="line">                    parent-&gt;driver-&gt;child_post_bind <span class="comment">//执行父设备驱动的bind函数 与父设备绑定 root未实现</span></span><br><span class="line">                    uc-&gt;uc_drv-&gt;post_bind(dev) <span class="comment">//执行uclass driver的bind函数 root未实现</span></span><br><span class="line">            device_probe(DM_ROOT_NON_CONST); <span class="comment">//prob dm_root root driver和 root classdriver 没有实际的方法 ，不会执行drv-&gt;probe post_prob pre_prob root设备状态为激活</span></span><br><span class="line">                uclass_resolve_seq(dev); \\为设备分配序列号</span><br><span class="line">                dev-&gt;seq = seq;</span><br><span class="line">                dev-&gt;flags |= DM_FLAG_ACTIVATED;</span><br><span class="line">        dm_scan_platdata(pre_reloc_only)</span><br><span class="line">            lists_bind_drivers(DM_ROOT_NON_CONST, pre_reloc_only);\\遍历driver_info数组 找到 dirverlist中对应的驱动，并创建设备，互相绑定</span><br><span class="line">                device_bind_by_name \\流程同上</span><br><span class="line">        dm_scan_fdt(gd-&gt;fdt_blob, pre_reloc_only);</span><br><span class="line">            dm_scan_fdt_node(gd-&gt;dm_root, blob, <span class="number">0</span>, pre_reloc_only);</span><br><span class="line">                lists_bind_fdt(parent, offset_to_ofnode(offset), <span class="literal">NULL</span>);</span><br><span class="line">                     compat_list = ofnode_get_property(node, <span class="string">&quot;compatible&quot;</span>, &amp;compat_length); \\找到所有带compatible的节点</span><br><span class="line">                     driver_check_compatible(entry-&gt;of_match, &amp;id,</span><br><span class="line">compat);   \\对每个节点  做一次 driver <span class="built_in">list</span>的遍历并对比名字</span><br><span class="line">                     ret = device_bind_with_driver_data(parent, entry, name,</span><br><span class="line">id-&gt;data, node, &amp;dev); </span><br><span class="line">                         device_bind_common(parent, drv, name, <span class="literal">NULL</span>, driver_data, node,</span><br><span class="line"><span class="number">0</span>, devp);                             </span><br></pre></td></tr></table></figure>

<h4 id="几个重要接口的总结："><a href="#几个重要接口的总结：" class="headerlink" title="几个重要接口的总结："></a><strong>几个重要接口的总结：</strong></h4><p>dm_init()：创建udevice和uclass空链表，创建根设备（root device）</p>
<p>dm_scan_platdata()：调用函数lists_bind_drivers，扫描U_BOOT_DEVICE定义的设备，与U_BOOT_DRIVER定义的driver进行查找，创建udevice，并绑定相应driver。</p>
<p>dm_scan_fdt()：扫描由FDT设备树文件定义的设备，与U_BOOT_DRIVER定义的driver进行查找，创建udevice，并绑定相应driver。</p>
<h4 id="uclass的创建："><a href="#uclass的创建：" class="headerlink" title="uclass的创建："></a><strong>uclass的创建：</strong></h4><p><img src="/uboot/WEBRESOURCE5b182cc0092b4977b6d36a0951a315b4image.png"></p>
<h4 id="lists-driver-lookup-name函数"><a href="#lists-driver-lookup-name函数" class="headerlink" title="lists_driver_lookup_name函数:"></a><strong>lists_driver_lookup_name函数:</strong></h4><p>#define U_BOOT_DRIVER(__name) \</p>
<p>ll_entry_declare(struct driver, __name, driver)</p>
<p>这里通过name寻找driver  是通过 uboot.map文件</p>
<p>u_boot_list_2_driver_1 是驱动开始标记</p>
<p>.u_boot_list_2_driver_3 是驱动结束标记</p>
<p>.u_boot_list_2_driver_2_xx  就是加入的设备驱动。</p>
<p>u_boot_list_2_driver_1和.u_boot_list_2_driver_3 用于定位作用 用于以下两个接口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ll_entry_start(<span class="keyword">struct</span> uclass_driver, uclass); </span><br><span class="line"><span class="comment">// 会根据.u_boot_list_2_uclass_1的段地址来得到uclass_driver table的地址</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> n_ents = ll_entry_count(<span class="keyword">struct</span> uclass_driver, uclass);<span class="comment">// 从uclass_driver table中获取uclass id为id的uclass_driver。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">.u_boot_list_2_driver_1  </span><br><span class="line">                <span class="number">0x00000000002d25c0</span>        <span class="number">0x0</span> drivers/built-in.o</span><br><span class="line"> .u_boot_list_2_driver_2_analogix_dp</span><br><span class="line">                <span class="number">0x00000000002d25c0</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d25c0</span>                _u_boot_list_2_driver_2_analogix_dp</span><br><span class="line"> .u_boot_list_2_driver_2_arasan_sdhci_drv</span><br><span class="line">                <span class="number">0x00000000002d2638</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2638</span>                _u_boot_list_2_driver_2_arasan_sdhci_drv</span><br><span class="line"> .u_boot_list_2_driver_2_clk_fixed_rate</span><br><span class="line">                <span class="number">0x00000000002d26b0</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d26b0</span>                _u_boot_list_2_driver_2_clk_fixed_rate</span><br><span class="line"> .u_boot_list_2_driver_2_clk_rk3399</span><br><span class="line">                <span class="number">0x00000000002d2728</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2728</span>                _u_boot_list_2_driver_2_clk_rk3399</span><br><span class="line"> .u_boot_list_2_driver_2_dmc_rk3399</span><br><span class="line">                <span class="number">0x00000000002d27a0</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d27a0</span>                _u_boot_list_2_driver_2_dmc_rk3399</span><br><span class="line"> .u_boot_list_2_driver_2_dw_mipi_dsi</span><br><span class="line">                <span class="number">0x00000000002d2818</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2818</span>                _u_boot_list_2_driver_2_dw_mipi_dsi</span><br><span class="line"> .u_boot_list_2_driver_2_ehci_generic</span><br><span class="line">                <span class="number">0x00000000002d2890</span>       <span class="number">0x78</span> drivers/usb/host/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2890</span>                _u_boot_list_2_driver_2_ehci_generic</span><br><span class="line"> .u_boot_list_2_driver_2_eth_designware</span><br><span class="line">                <span class="number">0x00000000002d2908</span>       <span class="number">0x78</span> drivers/net/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2908</span>                _u_boot_list_2_driver_2_eth_designware</span><br><span class="line"> .u_boot_list_2_driver_2_eth_gmac_rockchip</span><br><span class="line">                <span class="number">0x00000000002d2980</span>       <span class="number">0x78</span> drivers/net/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2980</span>                _u_boot_list_2_driver_2_eth_gmac_rockchip</span><br><span class="line"> .u_boot_list_2_driver_2_fixed_regulator</span><br><span class="line">                <span class="number">0x00000000002d29f8</span>       <span class="number">0x78</span> drivers/power/regulator/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d29f8</span>                _u_boot_list_2_driver_2_fixed_regulator</span><br><span class="line"> .u_boot_list_2_driver_2_generic_syscon</span><br><span class="line">                <span class="number">0x00000000002d2a70</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2a70</span>                _u_boot_list_2_driver_2_generic_syscon</span><br><span class="line"> .u_boot_list_2_driver_2_gpio_rockchip</span><br><span class="line">                <span class="number">0x00000000002d2ae8</span>       <span class="number">0x78</span> drivers/gpio/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2ae8</span>                _u_boot_list_2_driver_2_gpio_rockchip</span><br><span class="line"> .u_boot_list_2_driver_2_i2c_generic_chip_drv</span><br><span class="line">                <span class="number">0x00000000002d2b60</span>       <span class="number">0x78</span> drivers/i2c/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2b60</span>                _u_boot_list_2_driver_2_i2c_generic_chip_drv</span><br><span class="line"> .u_boot_list_2_driver_2_i2c_rockchip</span><br><span class="line">                <span class="number">0x00000000002d2bd8</span>       <span class="number">0x78</span> drivers/i2c/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2bd8</span>                _u_boot_list_2_driver_2_i2c_rockchip</span><br><span class="line"> .u_boot_list_2_driver_2_mmc</span><br><span class="line">                <span class="number">0x00000000002d2c50</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2c50</span>                _u_boot_list_2_driver_2_mmc</span><br><span class="line"> .u_boot_list_2_driver_2_mmc_blk</span><br><span class="line">                <span class="number">0x00000000002d2cc8</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2cc8</span>                _u_boot_list_2_driver_2_mmc_blk</span><br><span class="line"> .u_boot_list_2_driver_2_ns16550_serial</span><br><span class="line">                <span class="number">0x00000000002d2d40</span>       <span class="number">0x78</span> drivers/serial/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2d40</span>                _u_boot_list_2_driver_2_ns16550_serial</span><br><span class="line"> .u_boot_list_2_driver_2_ohci_generic</span><br><span class="line">                <span class="number">0x00000000002d2db8</span>       <span class="number">0x78</span> drivers/usb/host/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2db8</span>                _u_boot_list_2_driver_2_ohci_generic</span><br><span class="line"> .u_boot_list_2_driver_2_pinconfig_generic</span><br><span class="line">                <span class="number">0x00000000002d2e30</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2e30</span>                _u_boot_list_2_driver_2_pinconfig_generic</span><br><span class="line"> .u_boot_list_2_driver_2_pinctrl_rockchip</span><br><span class="line">                <span class="number">0x00000000002d2ea8</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2ea8</span>                _u_boot_list_2_driver_2_pinctrl_rockchip</span><br><span class="line"> .u_boot_list_2_driver_2_pmic_rk8xx</span><br><span class="line">                <span class="number">0x00000000002d2f20</span>       <span class="number">0x78</span> drivers/power/pmic/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2f20</span>                _u_boot_list_2_driver_2_pmic_rk8xx</span><br><span class="line"> .u_boot_list_2_driver_2_psci</span><br><span class="line">                <span class="number">0x00000000002d2f98</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d2f98</span>                _u_boot_list_2_driver_2_psci</span><br><span class="line"> .u_boot_list_2_driver_2_psci_sysreset</span><br><span class="line">                <span class="number">0x00000000002d3010</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3010</span>                _u_boot_list_2_driver_2_psci_sysreset</span><br><span class="line"> .u_boot_list_2_driver_2_pwm_backlight</span><br><span class="line">                <span class="number">0x00000000002d3088</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3088</span>                _u_boot_list_2_driver_2_pwm_backlight</span><br><span class="line"> .u_boot_list_2_driver_2_pwm_regulator</span><br><span class="line">                <span class="number">0x00000000002d3100</span>       <span class="number">0x78</span> drivers/power/regulator/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3100</span>                _u_boot_list_2_driver_2_pwm_regulator</span><br><span class="line"> .u_boot_list_2_driver_2_rk8xx_buck</span><br><span class="line">                <span class="number">0x00000000002d3178</span>       <span class="number">0x78</span> drivers/power/regulator/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3178</span>                _u_boot_list_2_driver_2_rk8xx_buck</span><br><span class="line"> .u_boot_list_2_driver_2_rk8xx_ldo</span><br><span class="line">                <span class="number">0x00000000002d31f0</span>       <span class="number">0x78</span> drivers/power/regulator/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d31f0</span>                _u_boot_list_2_driver_2_rk8xx_ldo</span><br><span class="line"> .u_boot_list_2_driver_2_rk8xx_switch</span><br><span class="line">                <span class="number">0x00000000002d3268</span>       <span class="number">0x78</span> drivers/power/regulator/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3268</span>                _u_boot_list_2_driver_2_rk8xx_switch</span><br><span class="line"> .u_boot_list_2_driver_2_rk_pwm</span><br><span class="line">                <span class="number">0x00000000002d32e0</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d32e0</span>                _u_boot_list_2_driver_2_rk_pwm</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_crypto_v1</span><br><span class="line">                <span class="number">0x00000000002d3358</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3358</span>                _u_boot_list_2_driver_2_rockchip_crypto_v1</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_display</span><br><span class="line">                <span class="number">0x00000000002d33d0</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d33d0</span>                _u_boot_list_2_driver_2_rockchip_display</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_dw_hdmi</span><br><span class="line">                <span class="number">0x00000000002d3448</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3448</span>                _u_boot_list_2_driver_2_rockchip_dw_hdmi</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_dwmmc_drv</span><br><span class="line">                <span class="number">0x00000000002d34c0</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d34c0</span>                _u_boot_list_2_driver_2_rockchip_dwmmc_drv</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_efuse</span><br><span class="line">                <span class="number">0x00000000002d3538</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3538</span>                _u_boot_list_2_driver_2_rockchip_efuse</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_lvds</span><br><span class="line">                <span class="number">0x00000000002d35b0</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d35b0</span>                _u_boot_list_2_driver_2_rockchip_lvds</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_panel</span><br><span class="line">                <span class="number">0x00000000002d3628</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3628</span>                _u_boot_list_2_driver_2_rockchip_panel</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_reset</span><br><span class="line">                <span class="number">0x00000000002d36a0</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d36a0</span>                _u_boot_list_2_driver_2_rockchip_reset</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_rgb</span><br><span class="line">                <span class="number">0x00000000002d3718</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3718</span>                _u_boot_list_2_driver_2_rockchip_rgb</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_rk3399_pmuclk</span><br><span class="line">                <span class="number">0x00000000002d3790</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3790</span>                _u_boot_list_2_driver_2_rockchip_rk3399_pmuclk</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_saradc</span><br><span class="line">                <span class="number">0x00000000002d3808</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3808</span>                _u_boot_list_2_driver_2_rockchip_saradc</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_usb2phy</span><br><span class="line">                <span class="number">0x00000000002d3880</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3880</span>                _u_boot_list_2_driver_2_rockchip_usb2phy</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_usb2phy_port</span><br><span class="line">                <span class="number">0x00000000002d38f8</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d38f8</span>                _u_boot_list_2_driver_2_rockchip_usb2phy_port</span><br><span class="line"> .u_boot_list_2_driver_2_rockchip_vop</span><br><span class="line">                <span class="number">0x00000000002d3970</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3970</span>                _u_boot_list_2_driver_2_rockchip_vop</span><br><span class="line"> .u_boot_list_2_driver_2_root_driver</span><br><span class="line">                <span class="number">0x00000000002d39e8</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d39e8</span>                _u_boot_list_2_driver_2_root_driver</span><br><span class="line"> .u_boot_list_2_driver_2_simple_bus_drv</span><br><span class="line">                <span class="number">0x00000000002d3a60</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3a60</span>                _u_boot_list_2_driver_2_simple_bus_drv</span><br><span class="line"> .u_boot_list_2_driver_2_simple_panel</span><br><span class="line">                <span class="number">0x00000000002d3ad8</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3ad8</span>                _u_boot_list_2_driver_2_simple_panel</span><br><span class="line"> .u_boot_list_2_driver_2_spi_generic_drv</span><br><span class="line">                <span class="number">0x00000000002d3b50</span>       <span class="number">0x78</span> drivers/spi/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3b50</span>                _u_boot_list_2_driver_2_spi_generic_drv</span><br><span class="line"> .u_boot_list_2_driver_2_syscon_rk3399</span><br><span class="line">                <span class="number">0x00000000002d3bc8</span>       <span class="number">0x78</span> arch/arm/mach-rockchip/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3bc8</span>                _u_boot_list_2_driver_2_syscon_rk3399</span><br><span class="line"> .u_boot_list_2_driver_2_sysreset_rockchip</span><br><span class="line">                <span class="number">0x00000000002d3c40</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3c40</span>                _u_boot_list_2_driver_2_sysreset_rockchip</span><br><span class="line"> .u_boot_list_2_driver_2_sysreset_syscon_reboot</span><br><span class="line">                <span class="number">0x00000000002d3cb8</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3cb8</span>                _u_boot_list_2_driver_2_sysreset_syscon_reboot</span><br><span class="line"> .u_boot_list_2_driver_2_usb_dev_generic_drv</span><br><span class="line">                <span class="number">0x00000000002d3d30</span>       <span class="number">0x78</span> drivers/usb/host/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3d30</span>                _u_boot_list_2_driver_2_usb_dev_generic_drv</span><br><span class="line"> .u_boot_list_2_driver_2_usb_generic_hub</span><br><span class="line">                <span class="number">0x00000000002d3da8</span>       <span class="number">0x78</span> common/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3da8</span>                _u_boot_list_2_driver_2_usb_generic_hub</span><br><span class="line"> .u_boot_list_2_driver_2_usb_mass_storage</span><br><span class="line">                <span class="number">0x00000000002d3e20</span>       <span class="number">0x78</span> common/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3e20</span>                _u_boot_list_2_driver_2_usb_mass_storage</span><br><span class="line"> .u_boot_list_2_driver_2_usb_storage_blk</span><br><span class="line">                <span class="number">0x00000000002d3e98</span>       <span class="number">0x78</span> common/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3e98</span>                _u_boot_list_2_driver_2_usb_storage_blk</span><br><span class="line"> .u_boot_list_2_driver_2_vidconsole_normal</span><br><span class="line">                <span class="number">0x00000000002d3f10</span>       <span class="number">0x78</span> drivers/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3f10</span>                _u_boot_list_2_driver_2_vidconsole_normal</span><br><span class="line"> .u_boot_list_2_driver_2_xhci_dwc3</span><br><span class="line">                <span class="number">0x00000000002d3f88</span>       <span class="number">0x78</span> drivers/usb/host/built-in.o</span><br><span class="line">                <span class="number">0x00000000002d3f88</span>                _u_boot_list_2_driver_2_xhci_dwc3</span><br><span class="line"> .u_boot_list_2_driver_3</span><br><span class="line">                <span class="number">0x00000000002d4000</span>        <span class="number">0x0</span> drivers/built-in.o</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-initr-dm与initf-dm的区别"><a href="#2-initr-dm与initf-dm的区别" class="headerlink" title="2.initr_dm与initf_dm的区别"></a>2.initr_dm与initf_dm的区别</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">initf_dm</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_DM) &amp;&amp; CONFIG_VAL(SYS_MALLOC_F_LEN)</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    bootstage_start(BOOTSTAGE_ID_ACCUM_DM_F, <span class="string">&quot;dm_f&quot;</span>);</span><br><span class="line">    ret = dm_init_and_scan(<span class="literal">true</span>);                   <span class="comment">//这里为true</span></span><br><span class="line">    bootstage_accum(BOOTSTAGE_ID_ACCUM_DM_F);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TIMER_EARLY</span></span><br><span class="line">    ret = dm_timer_init();</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">initr_dm</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Save the pre-reloc driver model and start a new one */</span></span><br><span class="line">    gd-&gt;dm_root_f = gd-&gt;dm_root;</span><br><span class="line">    gd-&gt;dm_root = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TIMER</span></span><br><span class="line">    gd-&gt;timer = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    bootstage_start(BOOTSTAGE_ID_ACCUM_DM_R, <span class="string">&quot;dm_r&quot;</span>);</span><br><span class="line">    ret = dm_init_and_scan(<span class="literal">false</span>);                      <span class="comment">//这里为false</span></span><br><span class="line">    bootstage_accum(BOOTSTAGE_ID_ACCUM_DM_R);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个均调用了dm_init_and_scan这个接口，这两个的关键区别在于参数的不同。</p>
<ul>
<li><p>首先说明一下dts节点中的“u-boot,dm-pre-reloc”属性，当设置了这个属性时，则表示这个设备在relocate之前就需要使用。</p>
</li>
<li><p>当dm_init_and_scan的参数为true时，只会对带有“u-boot,dm-pre-reloc”属性的节点进行解析。而当参数为false的时候，则会对所有节点都进行解析。</p>
</li>
</ul>
<h3 id="3-prob函数的执行"><a href="#3-prob函数的执行" class="headerlink" title="3.prob函数的执行"></a>3.prob函数的执行</h3><p>实际prob的执行都在 init_r里的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">board_init_r  common/board_r.c</span><br><span class="line">   <span class="title function_">initcall_run_list</span><span class="params">(init_sequence_r)</span></span><br><span class="line">        init_sequence_r[]</span><br><span class="line">            initr_dm <span class="comment">//对没有 pre-reloc的属性的设备 构建udevice和 uclass</span></span><br><span class="line">            initr_nand</span><br><span class="line">            initr_mmc</span><br><span class="line">            initr_ethaddr</span><br><span class="line">            initr_net</span><br><span class="line">            .......</span><br></pre></td></tr></table></figure>

<h4 id="MMC驱动"><a href="#MMC驱动" class="headerlink" title="MMC驱动"></a>MMC驱动</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">initr_mmc common/board_r.c</span><br><span class="line">    <span class="title function_">mmc_initialize</span><span class="params">(gd-&gt;bd)</span>; drivers/mmc/mmc.c</span><br><span class="line">        ret = mmc_probe(bis); </span><br><span class="line">            ret = uclass_get(UCLASS_MMC, &amp;uc); drivers/core/uclass.c</span><br><span class="line">            <span class="title function_">uclass_get_device_by_seq</span><span class="params">(UCLASS_MMC, i, &amp;dev)</span>;</span><br><span class="line">                uclass_find_device_by_seq \\先尝试按顺序找已探测的对比dev-&gt;seq和seq，然后找未探测的对比dev-&gt;req_seq请求序列与seq相同</span><br><span class="line">                uclass_get_device_tail</span><br><span class="line">                    ret = device_probe(dev); drivers/core/device.c</span><br><span class="line">            <span class="title function_">uclass_foreach_dev</span><span class="params">(dev, uc)</span> include/dm/uclass.h</span><br><span class="line">            <span class="title function_">device_probe</span><span class="params">(dev)</span>;</span><br><span class="line">                 drv-&gt;probe(dev);</span><br><span class="line">                 <span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">udevice_id</span> <span class="title">mc_sdhci_ids</span>[] =</span> &#123;</span><br><span class="line">            	    &#123; .compatible = <span class="string">&quot;mc,dw-sdhci&quot;</span> &#125;,</span><br><span class="line">	                &#123; &#125;</span><br><span class="line">                  &#125;;</span><br><span class="line">                  U_BOOT_DRIVER(mc_sdhci_drv) = &#123;</span><br><span class="line">	              .name		= <span class="string">&quot;mc_sdhci&quot;</span>,</span><br><span class="line">	              .id		= UCLASS_MMC,</span><br><span class="line">            	  .of_match	= mc_sdhci_ids,</span><br><span class="line">            	  .ops		= &amp;sdhci_ops,</span><br><span class="line">            	  .bind		= mc_sdhci_bind,</span><br><span class="line">	              .probe		= mc_sdhci_probe,</span><br><span class="line">	              .priv_auto_alloc_size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdhci_host),</span><br><span class="line">	              .platdata_auto_alloc_size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mc_sdhci_plat),</span><br><span class="line">                  &#125;;</span><br><span class="line">                      mc_sdhci_probe</span><br><span class="line">                          <span class="title function_">sdhci_probe</span><span class="params">(dev)</span>;</span><br><span class="line">                              sdhci_init</span><br><span class="line"></span><br><span class="line">                 </span><br><span class="line">                                                                                            </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">device_probe</span><br><span class="line">    drv = dev-&gt;driver;</span><br><span class="line">    uclass_resolve_seq(dev); \\分配seq序列号</span><br><span class="line">    dev-&gt;seq = seq;</span><br><span class="line"></span><br><span class="line">	dev-&gt;flags |= DM_FLAG_ACTIVATED; \\flag设置为激活状态</span><br><span class="line">    uclass_pre_probe_device(dev); 执行 uclass-&gt;drv-&gt;pre_prob</span><br><span class="line">    drv-&gt;probe(dev);</span><br><span class="line">    uclass_post_probe_device(dev); 执行 uclass-&gt;drv-&gt;post_prob</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h3 id="网络驱动"><a href="#网络驱动" class="headerlink" title="网络驱动"></a>网络驱动</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/04/27/uboot/" data-id="cma0w24va0002q8pu1esmf5s2" data-title="uboot详解" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-uboot指令" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/04/27/uboot%E6%8C%87%E4%BB%A4/" class="article-date">
  <time class="dt-published" datetime="2025-04-27T11:27:19.000Z" itemprop="datePublished">2025-04-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/04/27/uboot%E6%8C%87%E4%BB%A4/">uboot指令</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="查看当前支持命令"><a href="#查看当前支持命令" class="headerlink" title="查看当前支持命令"></a>查看当前支持命令</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--help</span><br><span class="line">?</span><br></pre></td></tr></table></figure>

<p>执行log如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">uboot#?</span><br><span class="line">?       - alias for &#x27;help&#x27;</span><br><span class="line">base    - print or set address offset</span><br><span class="line">bdinfo  - print Board Info structure</span><br><span class="line">bootelf - Boot from an ELF image in memory</span><br><span class="line">booti   - boot arm64 Linux Image image from memory</span><br><span class="line">bootm   - boot application image from memory</span><br><span class="line">bootp   - boot image via network using BOOTP/TFTP protocol</span><br><span class="line">bootvx  - Boot vxWorks from an ELF image</span><br><span class="line">bootz   - boot Linux zImage image from memory</span><br><span class="line">cdp     - Perform CDP network configuration</span><br><span class="line">cmp     - memory compare</span><br><span class="line">cp      - memory copy</span><br><span class="line">crc32   - checksum calculation</span><br><span class="line">ddr_info- ddr training info molchip soc</span><br><span class="line">dhcp    - boot image via network using DHCP/TFTP protocol</span><br><span class="line">dm      - Driver model low level access</span><br><span class="line">dns     - lookup the IP of a hostname</span><br><span class="line">dump_efuse- Dump the content of the efuses</span><br><span class="line">dump_osc- get FREQosc of the ring osc</span><br><span class="line">echo    - echo args to console</span><br><span class="line">efuse_write- write the content of the efuses</span><br><span class="line">env     - environment handling commands</span><br><span class="line">ethsw   - Ethernet l2 switch commands</span><br><span class="line">fdt     - flattened device tree utility commands</span><br><span class="line">go      - start application at address &#x27;addr&#x27;</span><br><span class="line">gunzip  - gunzip *.gz file</span><br><span class="line">hash    - hash_test molchip soc</span><br><span class="line">help    - print command description/usage</span><br><span class="line">iminfo  - print header information for application image</span><br><span class="line">linklocal- acquire a network IP address using the link-local protocol</span><br><span class="line">loop    - infinite loop on address range</span><br><span class="line">mc_mmc_dl_invalid- invalid dll</span><br><span class="line">mc_mmc_dl_scan- scan corrected mmc delay line settings mmc_dl_test + mode + way + step + addr + sector + len</span><br><span class="line">md      - memory display</span><br><span class="line">mdio    - MDIO utility commands</span><br><span class="line">mii     - MII utility commands</span><br><span class="line">mm      - memory modify (auto-incrementing address)</span><br><span class="line">mmc     - MMC sub system</span><br><span class="line">mmc_dl  - scan corrected mmc delay line settings</span><br><span class="line">mmc_dl_cmd_rx- scan corrected mmc delay line cmd rx dll</span><br><span class="line">mmcinfo - display MMC info</span><br><span class="line">mw      - memory write (fill)</span><br><span class="line">nand    - NAND sub-system</span><br><span class="line">nboot   - boot from NAND device</span><br><span class="line">nfs     - boot image via network using NFS protocol</span><br><span class="line">nm      - memory modify (constant address)</span><br><span class="line">pci     - list and access PCI Configuration Space</span><br><span class="line">ping    - send ICMP ECHO_REQUEST to network host</span><br><span class="line">printenv- print environment variables</span><br><span class="line">pxe     - commands to get and boot from pxe files</span><br><span class="line">rarpboot- boot image via network using RARP/TFTP protocol</span><br><span class="line">reboot  - reboot molchip soc</span><br><span class="line">reset   - Perform RESET of the CPU</span><br><span class="line">rsa_test- rsa_test molchip soc</span><br><span class="line">run     - run commands in an environment variable</span><br><span class="line">saveenv - save environment variables to persistent storage</span><br><span class="line">setenv  - set environment variables</span><br><span class="line">sf      - SPI flash sub-system</span><br><span class="line">sntp    - synchronize RTC via network</span><br><span class="line">source  - run script from memory</span><br><span class="line">sysboot - command to get and boot from syslinux files</span><br><span class="line">tftpboot- boot image via network using TFTP protocol</span><br><span class="line">tftpput - TFTP put command, for uploading files to a server</span><br><span class="line">tftpsrv - act as a TFTP server and boot the first received file</span><br><span class="line">version - print monitor, compiler and linker version</span><br><span class="line">write_osc- write the byp select of the ring osc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="信息查询"><a href="#信息查询" class="headerlink" title="信息查询"></a>信息查询</h1><h3 id="bdinfo"><a href="#bdinfo" class="headerlink" title="bdinfo"></a>bdinfo</h3><ul>
<li><p>命令用于<strong>查看开发板信息</strong></p>
</li>
<li></li>
</ul>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428172954760.png" alt="image-20250428172954760"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">1. arch_number = 0x00000000</span><br><span class="line">作用：表示架构编号。</span><br><span class="line">值：0x00000000，通常表示默认或未设置的架构编号。</span><br><span class="line">2. boot_params = 0x00000000</span><br><span class="line">作用：表示启动参数的地址。</span><br><span class="line">值：0x00000000，通常表示未设置或默认的启动参数地址。</span><br><span class="line">3. DRAM bank = 0x00000000</span><br><span class="line">作用：表示DRAM（动态随机存取存储器）银行的编号。</span><br><span class="line">值：0x00000000，通常表示第一个DRAM银行。</span><br><span class="line">4. -&gt; start = 0x140000000</span><br><span class="line">作用：表示DRAM的起始地址。</span><br><span class="line">值：0x140000000，即4GB的起始地址。</span><br><span class="line">5. -&gt; size = 0x80000000</span><br><span class="line">作用：表示DRAM的大小。</span><br><span class="line">值：0x80000000，即128MB。</span><br><span class="line">6. baudrate = 115200 bps</span><br><span class="line">作用：表示串行端口的波特率。</span><br><span class="line">值：115200，即每秒115200位。</span><br><span class="line">7. TLB addr = 0x1BFFF0000</span><br><span class="line">作用：表示TLB（Translation Lookaside Buffer，转换后备缓冲器）的地址。</span><br><span class="line">值：0x1BFFF0000，这是一个特定的内存地址。</span><br><span class="line">8. relocaddr = 0x1BFA8B000</span><br><span class="line">作用：表示重定位地址。</span><br><span class="line">值：0x1BFA8B000，这是代码和数据在内存中的新位置。</span><br><span class="line">9. reloc off = 0x2E48B000</span><br><span class="line">作用：表示重定位偏移量。</span><br><span class="line">值：0x2E48B000，这是从原始位置到新位置的偏移量。</span><br><span class="line">10. irq_sp = 0x1BFA591D0</span><br><span class="line">作用：表示中断堆栈指针的地址。</span><br><span class="line">值：0x1BFA591D0，这是一个特定的内存地址。</span><br><span class="line">11. sp start = 0x1BFA591D0</span><br><span class="line">作用：表示堆栈指针的起始地址。</span><br><span class="line">值：0x1BFA591D0，这是一个特定的内存地址。</span><br><span class="line">12. Early malloc usage: 1d0 / 8000</span><br><span class="line">作用：表示早期动态内存分配的使用情况。</span><br><span class="line">值：1d0 / 8000，表示已经使用了0x1D0字节，总大小为0x8000字节。</span><br><span class="line">13. fdt_blob = 00000001bfa591e0</span><br><span class="line">作用：表示设备树二进制（FDT）blob的地址。</span><br><span class="line">值：0x00000001bfa591e0，这是一个特定的内存地址。</span><br></pre></td></tr></table></figure>

<h3 id="printenv"><a href="#printenv" class="headerlink" title="printenv"></a>printenv</h3><p>打印环境变量</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173009044.png" alt="image-20250428173009044"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">1. arch=arm</span><br><span class="line">作用：指定架构类型。</span><br><span class="line">值：arm，表示使用ARM架构。</span><br><span class="line">2. baudrate=115200</span><br><span class="line">作用：指定串行端口的波特率。</span><br><span class="line">值：115200，即每秒115200位。</span><br><span class="line">3. board=molchip</span><br><span class="line">作用：指定板子的名称。</span><br><span class="line">值：molchip，表示使用的板子是molchip。</span><br><span class="line">4. board_name=molchip</span><br><span class="line">作用：指定板子的名称（重复定义）。</span><br><span class="line">值：molchip，表示使用的板子是molchip。</span><br><span class="line">5. bootcmd=mmc read 0x140000000 0x0 0x10000;mmc read 0x142000000 0x10000 0x200;booti 0x140000000 - 0x142000000;</span><br><span class="line">作用：定义启动命令。</span><br><span class="line">值：</span><br><span class="line">mmc read 0x140000000 0x0 0x10000：从MMC/SD卡的起始位置（块0）读取16384个块（0x10000）到地址0x140000000。</span><br><span class="line">mmc read 0x142000000 0x10000 0x200：从MMC/SD卡的第65536个块（0x10000）读取512个块（0x200）到地址0x142000000。</span><br><span class="line">booti 0x140000000 - 0x142000000：使用加载到0x140000000的内核和加载到0x142000000的设备树（DTB）启动系统。</span><br><span class="line">6. bootdelay=10</span><br><span class="line">作用：指定启动延迟时间。</span><br><span class="line">值：10，表示启动加载器在自动启动前等待10秒，以便用户可以中断启动过程并进入命令行模式。</span><br><span class="line">7. cpu=armv8</span><br><span class="line">作用：指定CPU架构版本。</span><br><span class="line">值：armv8，表示使用ARMv8架构。</span><br><span class="line">8. fdtcontroladdr=1bfa591e0</span><br><span class="line">作用：指定设备树控制地址。</span><br><span class="line">值：0x1bfa591e0，这是一个特定的内存地址，用于存储设备树控制信息。</span><br><span class="line">9. soc=molchip</span><br><span class="line">作用：指定系统-on-chip（SoC）的名称。</span><br><span class="line">值：molchip，表示使用的SoC是molchip。</span><br><span class="line">10. stderr=uart@0x18200000</span><br><span class="line">作用：指定标准错误输出的设备。</span><br><span class="line">值：uart@0x18200000，表示标准错误输出使用地址为0x18200000的UART设备。</span><br><span class="line">11. stdin=uart@0x18200000</span><br><span class="line">作用：指定标准输入的设备。</span><br><span class="line">值：uart@0x18200000，表示标准输入使用地址为0x18200000的UART设备。</span><br><span class="line">12. stdout=uart@0x18200000</span><br><span class="line">作用：指定标准输出的设备。</span><br><span class="line">值：uart@0x18200000，表示标准输出使用地址为0x18200000的UART设备</span><br></pre></td></tr></table></figure>

<h3 id="version"><a href="#version" class="headerlink" title="version"></a>version</h3><p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173019701.png" alt="image-20250428173019701"></p>
<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><h3 id="setenv"><a href="#setenv" class="headerlink" title="setenv"></a>setenv</h3><p>修改env到ram</p>
<p>setenv bootargs ‘mem&#x3D;mem_total earlycon console&#x3D;ttyS0,115200  root&#x3D;&#x2F;dev&#x2F;mmcblk0p3 rootfstype&#x3D;ext2 rw  init&#x3D;&#x2F;linuxrc blkdevparts&#x3D;mmcblk0:32M(kernel),128M(rootfs),2048M(app)’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs &#x27;mem=mem_total earlycon console=ttyS0,115200 root=/dev/mmcblk0p3  rootfstype=ext2 rw init=/linuxrc  blkdevparts=mmcblk0:32M(kernel),128M(dtb),2048M(rootfs)&#x27;</span><br></pre></td></tr></table></figure>

<p>删除环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs &#x27;mem=mem_total earlycon console=ttyS0,115200 root=/dev/mmcblk0p3 rootfstype=ext2 rw blkdevparts=mmcblk0:32M(kernel),128M(dtb),2048M(rootfs),4096M(userdata)&#x27;</span><br></pre></td></tr></table></figure>

<p>setenv bootcmd ‘mmc read 0x140000000 0x0 0x10000;mmc read 0x142000000 0x10000 0x200;booti 0x140000000 - 0x142000000;’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs &#x27;mem=mem_total earlycon console=ttyS0,115200 root=/dev/mmcblk0p3 rootfstype=ext2 rw  rootwait blkdevparts=mmcblk0:32M(kernel),128M(dtb),2048M(rootfs),4096M(userdata)&#x27;</span><br></pre></td></tr></table></figure>

<p>setenv author</p>
<h3 id="saveenv"><a href="#saveenv" class="headerlink" title="saveenv"></a><strong>saveenv</strong></h3><p>用于保存env到flash</p>
<h1 id="内存操作"><a href="#内存操作" class="headerlink" title="内存操作"></a>内存操作</h1><h2 id="md-命令"><a href="#md-命令" class="headerlink" title="md 命令"></a><strong>md 命令</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md[.b, .w, .l] address [# of objects]</span><br></pre></td></tr></table></figure>

<p>也就是分别以 1 个字节、 2 个字节、 4 个字节来显示内存值。 address 就是要查看的内存起始地址， [# of objects]表示要查看的数据长度，这个数据长度单位不是字节，而是跟你所选择的显示格式有关。比如你设置要查看的内存长度问为 20(十六进制为 0x14)，如果显示格式为.b 的话那就表示 20 个字节；如果显示格式为.w 的话就表示 20 个 word，也就是 20<em><strong>2&#x3D;40 个字节；如果显示格式为.l 的话就表示 20 个 long，也就是 20</strong></em>4&#x3D;80 个字节。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">md.b 80000000 10</span><br><span class="line">md.w 80000000 10</span><br><span class="line">md.l 80000000 10</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173036083.png" alt="image-20250428173036083"></p>
<h2 id="nm命令"><a href="#nm命令" class="headerlink" title="nm命令"></a>nm命令</h2><p><strong>nm 命令用于修改指定地址的内存值</strong>，命令格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nm [.b, .w, .l] address</span><br></pre></td></tr></table></figure>

<p>   nm 命令同样可以以.b、 .w 和.l 来指定操作格式，比如现在以.l 格式修改 0x80000000 地址的数据为 0x12345678。输入命令：</p>
<h2 id="mm"><a href="#mm" class="headerlink" title="mm"></a>mm</h2><p><strong>mm 命令也是修改指定地址内存值的，使用 mm 修改内存值的时候地址会自增，而使用命令 nm 的话地址不会自增</strong>。比如以.l 格式修改从地址 0x80000000 开始的连续 4个内存块(4*4&#x3D;12个字节)的数据为 0X05050505，操作如图 所示：</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173036083.png"></p>
<h2 id="mw-命令"><a href="#mw-命令" class="headerlink" title="mw 命令"></a>mw 命令</h2><p>命令 mw 用于<strong>使用一个指定的数据填充一段内存</strong>，命令格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mw [.b, .w, .l] address value [count]</span><br></pre></td></tr></table></figure>

<p> mw 命令同样可以以.b、 .w 和.l 来指定操作格式， address 表示要填充的内存起始地址， value为要填充的数据， count 是填充的长度。比如使用.l 格式将以 0X80000000 为起始地址的 0x10 个内存块(0x10 * 4&#x3D;64 字节)填充为 0X0A0A0A0A，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mw.l 80000000 0A0A0A0A 10</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173036083.png"></p>
<h2 id="cp"><a href="#cp" class="headerlink" title="**cp **"></a>**cp **</h2><p>cp 是<strong>数据拷贝命令，用于将 DRAM 中的数据从一段内存拷贝到另一段内存中</strong>，命令格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp [.b, .w, .l] source target count</span><br></pre></td></tr></table></figure>

<p>  cp 命令同样可以以.b、 .w 和.l 来指定操作格式， source 为源地址， target 为目的地址， count为拷贝的长度。我们使用.l 格式将 0x80000000 处的地址拷贝到 0X80000100 处，长度为 0x10 个内存块(0x10 * 4&#x3D;64 个字节)，命令如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp.l 80000000 80000100 10</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173112871.png" alt="image-20250428173112871"></p>
<h2 id="cmp-命令"><a href="#cmp-命令" class="headerlink" title="cmp 命令"></a>cmp 命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmp [.b, .w, .l] addr1 addr2 count</span><br></pre></td></tr></table></figure>

<p> cmp 命令同样可以以.b、 .w 和.l 来指定操作格式， addr1 为第一段内存首地址， addr2 为第二段内存首地址， count 为要比较的长度。我们使用.l 格式来比较 0x80000100 和 0X80000200 这两个地址数据是否相等，比较长度为 0x10 个内存块(16 * 4&#x3D;64 个字节)，命令如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmp.l 80000100 80000200 10</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173133062.png" alt="image-20250428173133062"></p>
<h1 id="网络操作"><a href="#网络操作" class="headerlink" title="网络操作"></a>网络操作</h1><p>uboot 是支持网络的，我们在移植 uboot 的时候一般都要调通网络功能，因为在移植 linux kernel 的时候需要使用到 uboot 的网络功能做调试。uboot 支持大量的网络相关命令，比如 dhcp、ping、 nfs 和 tftpboot等。</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173137228.png" alt="image-20250428173137228"></p>
<h2 id="ping-命令"><a href="#ping-命令" class="headerlink" title="ping 命令"></a><strong>ping 命令</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ping 192.168.1.117</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="dhcp命令"><a href="#dhcp命令" class="headerlink" title="dhcp命令"></a>dhcp命令</h2><p>dhcp <strong>用于从<strong><strong>路由器</strong></strong>获取 IP 地址</strong>，前提得开发板连接到路由器上的，如果开发板是和电脑直连的，那么 dhcp 命令就会失效。直接输入 dhcp 命令即可通过路由器获取到 IP 地址。</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173133062.png"></p>
<h2 id="nfs命令"><a href="#nfs命令" class="headerlink" title="nfs命令"></a>nfs命令</h2><p> <strong>nfs 也就是网络**<strong>文件系统</strong></strong>，通过 nfs 可以在计算机之间通过网络来分享资源**，比如我们将linux 镜像和设备树文件放到 Ubuntu 中，然后在 uboot 中使用 nfs 命令将 Ubuntu 中的 linux 镜像和设备树下载到开发板的 DRAM 中。</p>
<pre><code>   我们一般使用 uboot 中的 nfs 命令将 Ubuntu 中的文件下载到开发板的 DRAM 中，在使用之前需要开启 Ubuntu 主机的 NFS 服务，并且要新建一个 NFS 使用的目录，以后所有要通过NFS 访问的文件都需要放到这个 NFS 目录中。准备好以后就可以使用 nfs 命令来将 zImage 下载到开发板 DRAM 的 0X80800000 地址处，命令如下：
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nfs 80800000 192.168.1.105:/home/wanli/linux/nfs/zImage</span><br></pre></td></tr></table></figure>

<p>命 令 中 的 “ 80800000 ” 表 示 zImage 保 存 地 址 ，“</p>
<p>192.168.1.105:&#x2F;home&#x2F;zuozhongkai&#x2F;linux&#x2F;nfs&#x2F;zImage”表示 zImage 在 192.168.1.250 这个主机中，路径为</p>
<p>home&#x2F;wanli&#x2F;linux&#x2F;nfs&#x2F;zImage</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173231748.png" alt="image-20250428173231748"></p>
<h2 id="ftp命令"><a href="#ftp命令" class="headerlink" title="ftp命令"></a>ftp命令</h2><p>  tftp 命令的作用和 nfs 命令一样，都是用于<strong>通过网络下载东西到 DRAM 中</strong>，只是 tftp 命令使用的 TFTP 协议， Ubuntu 主机作为 TFTP 服务器。因此需要在 Ubuntu 上搭建 TFTP 服务器，需要安装 tftp-hpa 和 tftpd-hpa，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install tftp-hpa tftpd-hpa </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/wanli/linux/tftpboot</span><br><span class="line">chmod 777 /home/wanli/linux/tftpboot</span><br></pre></td></tr></table></figure>

<p> 最后配置 tftp，打开文件安装完成以后新建文件&#x2F;etc&#x2F;xinetd.d&#x2F;tftp，然后在里面输入如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server tftp</span><br><span class="line">&#123; </span><br><span class="line">   </span><br><span class="line">	 socket_type = dgram</span><br><span class="line">	 protocol = udp</span><br><span class="line">	 wait = yes</span><br><span class="line">	 user = root</span><br><span class="line">	 server = /usr/sbin/in.tftpd</span><br><span class="line">	 server_args = -s /home/wanli/linux/tftpboot/</span><br><span class="line">	 disable = no</span><br><span class="line">	 per_source = 11</span><br><span class="line">	 cps = 100 2</span><br><span class="line">	 flags = IPv4</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service tftpd-hpa start</span><br></pre></td></tr></table></figure>

<p>打开&#x2F;etc&#x2F;default&#x2F;tftpd-hpa 文件，将其修改为如下所示内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># /etc/default/tftpd-hpa</span><br><span class="line"></span><br><span class="line">TFTP_USERNAME=&quot;tftp&quot;</span><br><span class="line">TFTP_DIRECTORY=&quot;/home/wanli/linux/tftpboot&quot;</span><br><span class="line">TFTP_ADDRESS=&quot;:69&quot;</span><br><span class="line">TFTP_OPTIONS=&quot;-l -c -s&quot;</span><br></pre></td></tr></table></figure>

<p>TFTP_DIRECTORY 就是我们上面创建的 tftp 文件夹目录，以后我们就将所有需要通过TFTP 传输的文件都放到这个文件夹里面，并且要给予这些文件相应的权限。最后输入如下命令， 重启 tftp 服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service tftpd-hpa restart</span><br></pre></td></tr></table></figure>

<p>uboot 中的 tftp 命令格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tftpboot [loadAddress] [[hostIPaddr:]bootfilename]</span><br></pre></td></tr></table></figure>

<p>看 起 来 和 nfs 命 令 格式 一 样 的 ， loadAddress 是 文 件 在 DRAM 中 的存 放 地 址 ，[[hostIPaddr:]bootfilename]是要从 Ubuntu 中下载的文件。但是和 nfs 命令的区别在于， <strong>tftp 命令不需要输入文件在 Ubuntu 中的完整路径，只需要输入文件名即可</strong>。比如我们现在将 tftpboot 文件夹里面的 zImage 文件下载到开发板 DRAM 的 0X80800000 地址处，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tftp 80800000 zImage</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173245639.png" alt="image-20250428173245639"></p>
<h1 id="emmc和sd卡操作"><a href="#emmc和sd卡操作" class="headerlink" title="emmc和sd卡操作"></a>emmc和sd卡操作</h1><p>  uboot 支持 EMMC 和 SD 卡，因此也要提供 EMMC 和 SD 卡的操作命令。一般认为 EMMC和 SD 卡是同一个东西，所以没有特殊说明，mmc 是一系列的命令，其后可以跟不同的参数。</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173429095.png" alt="image-20250428173429095"></p>
<p>加上 SD 卡一共有两个 MMC 设备， FSL_SDHC:0 是 SD卡， FSL_SDHC:1(eMMC)是 EMMC，。默认会将 EMMC 设置为当前 MMC 设备，这就是为什么输入“mmc info”查询到的是 EMMC 设备信息，而不是 SD 卡。要想查看 SD 卡信息，就要使用命令“mmc dev”来将 SD 卡设置为当前的 MMC 设备。mmc dev 命令用于切换当前 MMC 设备，命令格式如下：</p>
<h2 id="mmc-dev"><a href="#mmc-dev" class="headerlink" title="mmc dev"></a>mmc dev</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc dev [dev] [part]</span><br></pre></td></tr></table></figure>

<p>[dev]用来设置要切换的 MMC 设备号， [part]是分区号。如果不写分区号的话默认为分区 0。使用如下命令切换到 SD 卡：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc dev 0 //切换到 SD 卡， 0 为 SD 卡， 1 为 eMMC</span><br></pre></td></tr></table></figure>

<p>有时候 SD 卡或者 EMMC 会有多个分区，**第 0 个分区存放 uboot，第 1 个分区存放 Linux 镜像文件和设备树，第 2 个分区存放根文件系统。**要将数据写到 MMC 设备里面，可以使用命令“mmc write”，格式如下：’</p>
<h2 id="mmc-write"><a href="#mmc-write" class="headerlink" title="mmc write"></a>mmc write</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc write addr blk# cnt</span><br></pre></td></tr></table></figure>

<p>addr 是要写入 MMC 中的数据在 DRAM 中的起始地址， blk 是要写入 MMC 的块起始地址(十六进制)， cnt 是要写入的块大小，<strong>一个块为 512 字节</strong>。我们可以<strong>使用命令<strong><strong>mmc write</strong></strong>来升级 uboot，也就是在 uboot 中更新 uboot。</strong></p>
<pre><code>   通过 nfs 或者 tftp 命令将新的 u-boot.bin 下载到开发板的 DRAM 中，然后再使用命令“mmc write”将其写入到 MMC设备中。我们就来更新一下 SD 中的 uboot，先查看一下 SD 卡中的 uboot 版本号，注意编译时间，输入命令：
</code></pre>
<p>mmc dev 0 &#x2F;&#x2F;切换到 SD 卡</p>
<p>version &#x2F;&#x2F;查看版本号</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173439158.png" alt="image-20250428173439158"></p>
<p>  然后将编译出来的 u-boot.imx(u-boot.bin 前面加了一些头文件)拷贝到 Ubuntu 中的nfs对应目录下。最后使用 nfs命令将其下载到 0x80800000 地址处，命令如下：</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173439158.png"></p>
<p>可以看出， u-boot.imx 大小为 424960 字节， 424960&#x2F;512&#x3D;830，所以我们要向 SD 卡中写入830个块，如果有小数的话就要加 1 个块。使用命令“mmc write”从 SD 卡分区 0 第 2 个块(扇区)开始烧写，一共烧写 830(0x33E)个块，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mmc dev 0</span><br><span class="line">mmc write 80800000 2 33E</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173456033.png" alt="image-20250428173456033"></p>
<p> 烧写成功，重启开发板(从 SD 卡启动)，重启以后再输入 version 来查看版本号，结果如图:</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173500946.png" alt="image-20250428173500946"></p>
<p><strong>千万不要写 SD 卡或者 EMMC 的前两个块(扇区)，里面保存着分区表！</strong></p>
<p>**        千万不要写 SD 卡或者 EMMC 的前两个块(扇区)，里面保存着分区表！**</p>
<p>**        千万不要写 SD 卡或者 EMMC 的前两个块(扇区)，里面保存着分区表！**</p>
<h1 id="FAT格式文件操作"><a href="#FAT格式文件操作" class="headerlink" title="FAT格式文件操作"></a>FAT格式文件操作</h1><h2 id="fatinfo"><a href="#fatinfo" class="headerlink" title="fatinfo"></a>fatinfo</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatinfo &lt;interface&gt; [&lt;dev[:part]&gt;]</span><br></pre></td></tr></table></figure>

<p>interface 表示接口，比如 mmc， dev 是查询的设备号， part 是要查询的分区。比如我们要查询 EMMC 分区 1 的文件系统信息，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatinfo mmc 1:1</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173510834.png" alt="image-20250428173510834"></p>
<h2 id="fatls"><a href="#fatls" class="headerlink" title="fatls"></a>fatls</h2><p> fatls 命令用于<strong>查询 FAT 格式设备的目录和文件信息</strong>，命令格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatls &lt;interface&gt; [&lt;dev[:part]&gt;] [directory]</span><br></pre></td></tr></table></figure>

<p> interface 是要查询的接口，比如 mmc， dev 是要查询的设备号， part 是要查询的分区， directory是要查询的目录。比如查询 EMMC 分区 1 中的所有的目录和文件，输入命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatls mmc 1:1</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173510834.png"></p>
<p>   从上图可以看出， emmc 的分区 1 中存放着两个文件，文件分别是 linux 镜像（zimage）文件和设备树。并且在 emmc 的分区 1 中有6个文件，没有目录。</p>
<h2 id="fstype"><a href="#fstype" class="headerlink" title="fstype"></a>fstype</h2><p>fstype 用于查看 MMC 设备某个分区的文件系统格式，命令格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fstype &lt;interface&gt; &lt;dev&gt;:&lt;part&gt;</span><br></pre></td></tr></table></figure>

<p>   正点原子 EMMC 核心板上的 EMMC 默认有 3 个分区，我们来查看一下这三个分区的文件系统格式，输入命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fstype mmc 1:0</span><br><span class="line">fstype mmc 1:1</span><br><span class="line">fstype mmc 1:2</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173524440.png" alt="image-20250428173524440"></p>
<p>上图可以看出，分区 0 格式未知，因为分区 0 存放的 uboot，<strong>并且分区 0 没有格式化，所以文件系统格式未知</strong>。<strong>分区 1 的格式为 fat，分区 1 用于存放 linux 镜像和设备树。分区 2 的格式为 ext4，用于存放 Linux 的跟文件系统。</strong></p>
<h2 id="fatload-命令"><a href="#fatload-命令" class="headerlink" title="fatload 命令"></a><strong>fatload 命令</strong></h2><pre><code>   fatload 命令用于**将指定的文件读取到 DRAM** 中，命令格式如下：
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatload &lt;interface&gt; [&lt;dev[:part]&gt; [&lt;addr&gt; [&lt;filename&gt; [bytes [pos]]]]]</span><br></pre></td></tr></table></figure>

<p>interface 为接口，比如 mmc， dev 是设备号， part 是分区， addr 是保存在 DRAM 中的起始地址， filename 是要读取的文件名字。 bytes 表示读取多少字节的数据，如果 bytes 为 0 或者省略的话表示读取整个文件。 pos 是要读的文件相对于文件首地址的偏移，如果为 0 或者省略的话表示从文件首地址开始读取。我们将 EMMC 分区 1 中的zImage 文件读取到 DRAM 中的0X80800000 地址处，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatload mmc 1:1 80800000 zImage</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173530806.png" alt="image-20250428173530806"></p>
<p>从上图可以看出在 153ms 内读取了 6071136 个字节的数据，速度为 29.2MiB&#x2F;s，速度是非常快的，因为这是从EMMC 里面读取的，而 EMMC 是 8 位的，速度肯定会很快的。</p>
<pre><code>   zImage 大小为 6777096(0X67 6908)个字节，接下来使用命令 fatwrite 将其写入到 EMMC 的分区 1 中，文件名字为 zImage，命令如下
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatwrite mmc 1:1 80800000 zImage 0x676908</span><br></pre></td></tr></table></figure>

<p>完成以后使用“fatls”命令查看一下 EMMC 分区 1 里面的文件，结果如图 </p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173530806.png"></p>
<h1 id="EXT格式文件操作"><a href="#EXT格式文件操作" class="headerlink" title="EXT格式文件操作"></a>EXT格式文件操作</h1><p>uboot 有 ext2 和 ext4 这两种格式的文件系统的操作命令，常用的就四个命令，分别为：</p>
<p>ext2load、 ext2ls、 ext4load、 ext4ls 和 ext4write。这些命令的含义和使用与 fatload、 fatls 和 fatwrit一样，只是 ext2 和 ext4 都是针对 ext 文件系统的。比如 ext4ls 命令， EMMC 的分区 2 就是 ext4格式的，使用 ext4ls 就可以查询 EMMC 的 2 中的文件和目录，输入命令：</p>
<p>ext4ls mmc 1:2</p>
<p><img src="https://raw.githubusercontent.com/LeonKeBSP/ImgHosting/main/hexo/image-20250428173542360.png" alt="image-20250428173542360"></p>
<h1 id="boot操作命令"><a href="#boot操作命令" class="headerlink" title="boot操作命令"></a>boot操作命令</h1><h1 id="其他常用命令"><a href="#其他常用命令" class="headerlink" title="其他常用命令"></a>其他常用命令</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/04/27/uboot%E6%8C%87%E4%BB%A4/" data-id="cma0w24v50000q8pu479e0jp1" data-title="uboot指令" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-uboot源码函数调用分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/04/27/uboot%E6%BA%90%E7%A0%81%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2025-04-27T11:27:19.000Z" itemprop="datePublished">2025-04-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/04/27/uboot%E6%BA%90%E7%A0%81%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90/">uboot源码函数调用分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">u-boot:启动详细的代码调用流程</span><br><span class="line">u-boot.lds:(arch/arm/cpu/u-boot.lds)</span><br><span class="line">    |--&gt;_start:(arch/arm/lib/vectors.S)</span><br><span class="line">        |--&gt;reset(arch/arm/cpu/armv7/start.S)    </span><br><span class="line">            |--&gt;save_boot_params(arch/arm/cpu/armv7/start.S)/*将引导参数保存到内存中*/</span><br><span class="line">                |--&gt;save_boot_params_ret(arch/arm/cpu/armv7/start.S)</span><br><span class="line">                    |--&gt;cpu_init_cp15(arch/arm/cpu/armv7/start.S)/*初始化*/</span><br><span class="line">                    |--&gt;cpu_init_crit(arch/arm/cpu/armv7/start.S)</span><br><span class="line">                        |--&gt;lowlevel_init(arch/arm/cpu/armv7/lowlevel_init.S)</span><br><span class="line">                    |--&gt;_main(arch/arm/lib/crt0.S)</span><br><span class="line">                        |--&gt;board_init_f_alloc_reserve(common/init/board_init.c)/*为u-boot的gd结构体分配空间*/</span><br><span class="line">                        |--&gt;board_init_f_init_reserve(common/init/board_init.c)    /*将gd结构体清零*/</span><br><span class="line">                        |--&gt;board_init_f(common/board_f.c)</span><br><span class="line">                            |--&gt;initcall_run_list(include/initcall.h)    /*初始化序列函数*/</span><br><span class="line">                                |--&gt;init_sequence_f[](common/board_f.c)    /* 初始化序列函数数组 */</span><br><span class="line">                                    |--&gt;board_early_init_f(board/freescale/mx6ull_toto/mx6ull_toto.c)/*初始化串口的IO配置*/</span><br><span class="line">                                    |--&gt;timer_init(arch/arm/imx-common/timer.c)    /*初始化内核定时器，为uboot提供时钟节拍*/</span><br><span class="line">                                    |--&gt;init_baud_rate(common/board_f.c)        /*初始化波特率*/</span><br><span class="line">                                    |--&gt;serial_init(drivers/serial/serial.c)    /*初始化串口通信设置*/</span><br><span class="line">                                    |--&gt;console_init_f(common/console.c)        /*初始化控制台*/</span><br><span class="line">                                    |--&gt;...</span><br><span class="line">                        |--&gt;relocate_code(arch/arm/lib/relocate.S)    /*主要完成镜像拷贝和重定位*/</span><br><span class="line">                        |--&gt;relocate_vectors(arch/arm/lib/relocate.S)/*重定位向量表*/</span><br><span class="line">                        |--&gt;board_init_r(common/board_r.c)/*板级初始化*/</span><br><span class="line">                            |--&gt;initcall_run_list(include/initcall.h)/*初始化序列函数*/</span><br><span class="line">                                |--&gt;init_sequence_r[](common/board_f.c)/*序列函数*/</span><br><span class="line">                                    |--&gt;initr_reloc(common/board_r.c)    /*设置 gd-&gt;flags,标记重定位完成*/</span><br><span class="line">                                    |--&gt;serial_initialize(drivers/serial/serial-uclass.c)/*初始化串口*/</span><br><span class="line">                                        |--&gt;serial_init(drivers/serial/serial-uclass.c)     /*初始化串口*/</span><br><span class="line">                                    |--&gt;initr_mmc(common/board_r.c)                         /*初始化emmc*/</span><br><span class="line">                                        |--&gt;mmc_initialize(drivers/mmc/mmc.c)</span><br><span class="line">                                            |--&gt;mmc_do_preinit(drivers/mmc/mmc.c)</span><br><span class="line">                                                |--&gt;mmc_start_init(drivers/mmc/mmc.c)</span><br><span class="line">                                    |--&gt;console_init_r(common/console.c)                /*初始化控制台*/</span><br><span class="line">                                    |--&gt;interrupt_init(arch/arm/lib/interrupts.c)        /*初始化中断*/</span><br><span class="line">                                    |--&gt;initr_net(common/board_r.c)                        /*初始化网络设备*/</span><br><span class="line">                                        |--&gt;eth_initialize(net/eth-uclass.c)</span><br><span class="line">                                            |--&gt;eth_common_init(net/eth_common.c)</span><br><span class="line">                                                |--&gt;phy_init(drivers/net/phy/phy.c)</span><br><span class="line">                                            |--&gt;uclass_first_device_check(drivers/core/uclass.c)</span><br><span class="line">                                                |--&gt;uclass_find_first_device(drivers/core/uclass.c)</span><br><span class="line">                                                |--&gt;device_probe(drivers/core/device.c)</span><br><span class="line">                                                    |--&gt;device_of_to_plat(drivers/core/device.c)</span><br><span class="line">                                                        |--&gt;drv-&gt;of_to_plat</span><br><span class="line">                                                            |--&gt;fecmxc_of_to_plat(drivers/net/fec_mxc.c)/*解析设备树信息*/</span><br><span class="line">                                                    |--&gt;device_get_uclass_id(drivers/core/device.c)</span><br><span class="line">                                                    |--&gt;uclass_pre_probe_device(drivers/core/uclass.c)</span><br><span class="line">                                                    |--&gt;drv-&gt;probe(dev)</span><br><span class="line">                                                        /*drivers/net/fec_mxc.c*/</span><br><span class="line">                                                        U_BOOT_DRIVER(fecmxc_gem) = &#123;</span><br><span class="line">                                                            .name    = &quot;fecmxc&quot;,</span><br><span class="line">                                                            .id    = UCLASS_ETH,</span><br><span class="line">                                                            .of_match = fecmxc_ids,</span><br><span class="line">                                                            .of_to_plat = fecmxc_of_to_plat,</span><br><span class="line">                                                            .probe    = fecmxc_probe,</span><br><span class="line">                                                            .remove    = fecmxc_remove,</span><br><span class="line">                                                            .ops    = &amp;fecmxc_ops,</span><br><span class="line">                                                            .priv_auto    = sizeof(struct fec_priv),</span><br><span class="line">                                                            .plat_auto    = sizeof(struct eth_pdata),</span><br><span class="line">                                                        &#125;;</span><br><span class="line">                                                        |--&gt;fecmxc_probe(drivers/net/fec_mxc.c)/*探测和初始化*/</span><br><span class="line">                                                            |--&gt;fec_get_miibus(drivers/net/fec_mxc.c)</span><br><span class="line">                                                                |--&gt;mdio_alloc(drivers/net/fec_mxc.c)</span><br><span class="line">                                                                |--&gt;bus-&gt;read = fec_phy_read;</span><br><span class="line">                                                                |--&gt;bus-&gt;write = fec_phy_write;</span><br><span class="line">                                                                |--&gt;mdio_register(common/miiphyutil.c)</span><br><span class="line">                                                                |--&gt;fec_mii_setspeed(drivers/net/fec_mxc.c)</span><br><span class="line">                                                            |--&gt;fec_phy_init(drivers/net/fec_mxc.c)</span><br><span class="line">                                                                |--&gt;device_get_phy_addr(drivers/net/fec_mxc.c)</span><br><span class="line">                                                                |--&gt;phy_connect(drivers/net/phy/phy.c)</span><br><span class="line">                                                                    |--&gt;phy_find_by_mask(drivers/net/phy/phy.c)</span><br><span class="line">                                                                        |--&gt;bus-&gt;reset(bus)</span><br><span class="line">                                                                        |--&gt;get_phy_device_by_mask(drivers/net/phy/phy.c)</span><br><span class="line">                                                                            |--&gt;create_phy_by_mask(drivers/net/phy/phy.c)</span><br><span class="line">                                                                                |--&gt;phy_device_create(drivers/net/phy/phy.c)</span><br><span class="line">                                                                                    |--&gt;phy_probe(drivers/net/phy/phy.c)</span><br><span class="line">                                                                    |--&gt;phy_connect_dev(drivers/net/phy/phy.c)</span><br><span class="line">                                                                        |--&gt;phy_reset(drivers/net/phy/phy.c)</span><br><span class="line">                                                                |--&gt;phy_config(drivers/net/phy/phy.c)</span><br><span class="line">                                                                    |--&gt;board_phy_config(drivers/net/phy/phy.c)</span><br><span class="line">                                                                        |--&gt;phydev-&gt;drv-&gt;config(phydev)</span><br><span class="line">                                                                            /*drivers/net/phy/smsc.c*/</span><br><span class="line">                                                                            static struct phy_driver lan8710_driver = &#123;</span><br><span class="line">                                                                                .name = &quot;SMSC LAN8710/LAN8720&quot;,</span><br><span class="line">                                                                                .uid = 0x0007c0f0,</span><br><span class="line">                                                                                .mask = 0xffff0,</span><br><span class="line">                                                                                .features = PHY_BASIC_FEATURES,</span><br><span class="line">                                                                                .config = &amp;genphy_config_aneg,</span><br><span class="line">                                                                                .startup = &amp;genphy_startup,</span><br><span class="line">                                                                                .shutdown = &amp;genphy_shutdown,</span><br><span class="line">                                                                            &#125;;</span><br><span class="line">                                                                            |--&gt;genphy_config_aneg(drivers/net/phy/phy.c)</span><br><span class="line">                                                                                |--&gt;phy_reset(需要手动调用)(drivers/net/phy/phy.c)</span><br><span class="line">                                                                                |--&gt;genphy_setup_forced(drivers/net/phy/phy.c)</span><br><span class="line">                                                                                |--&gt;genphy_config_advert(drivers/net/phy/phy.c)</span><br><span class="line">                                                                                |--&gt;genphy_restart_aneg(drivers/net/phy/phy.c)</span><br><span class="line">                                                    |--&gt;uclass_post_probe_device(drivers/core/uclass.c)</span><br><span class="line">                                                        |--&gt;uc_drv-&gt;post_probe(drivers/core/uclass.c)</span><br><span class="line">                                                            /*net/eth-uclass.c*/</span><br><span class="line">                                                            UCLASS_DRIVER(ethernet) = &#123;</span><br><span class="line">                                                                .name        = &quot;ethernet&quot;,</span><br><span class="line">                                                                .id        = UCLASS_ETH,</span><br><span class="line">                                                                .post_bind    = eth_post_bind,</span><br><span class="line">                                                                .pre_unbind    = eth_pre_unbind,</span><br><span class="line">                                                                .post_probe    = eth_post_probe,</span><br><span class="line">                                                                .pre_remove    = eth_pre_remove,</span><br><span class="line">                                                                .priv_auto    = sizeof(struct eth_uclass_priv),</span><br><span class="line">                                                                .per_device_auto    = sizeof(struct eth_device_priv),</span><br><span class="line">                                                                .flags        = DM_UC_FLAG_SEQ_ALIAS,</span><br><span class="line">                                                            &#125;;</span><br><span class="line">                                                            |--&gt;eth_post_probe(net/eth-uclass.c)</span><br><span class="line">                                                                |--&gt;eth_write_hwaddr(drivers/core/uclass.c)</span><br><span class="line">                                    |--&gt;...</span><br><span class="line">                                    |--&gt;run_main_loop(common/board_r.c)/*主循环，处理命令*/</span><br><span class="line">                                        |--&gt;main_loop(common/main.c)</span><br><span class="line">                                            |--&gt;bootdelay_process(common/autoboot.c)    /*读取环境变量bootdelay和bootcmd的内容*/</span><br><span class="line">                                            |--&gt;autoboot_command(common/autoboot.c)        /*倒计时按下执行，没有操作执行bootcmd的参数*/</span><br><span class="line">                                                |--&gt;abortboot(common/autoboot.c)</span><br><span class="line">                                                    |--&gt;printf(&quot;Hit any key to stop autoboot: %2d &quot;, bootdelay);</span><br><span class="line">                                                    /*到这里就是我们看到uboot延时3s启动内核的地方*/</span><br><span class="line">                                            |--&gt;cli_loop(common/cli.c)    /*倒计时按下space键,执行用户输入命令*/</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/04/27/uboot%E6%BA%90%E7%A0%81%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90/" data-id="cma0w24v80001q8pu5kaxc3l6" data-title="uboot源码函数调用分析" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">April 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/04/27/uboot/">uboot详解</a>
          </li>
        
          <li>
            <a href="/2025/04/27/uboot%E6%8C%87%E4%BB%A4/">uboot指令</a>
          </li>
        
          <li>
            <a href="/2025/04/27/uboot%E6%BA%90%E7%A0%81%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90/">uboot源码函数调用分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 leon<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>